#!/bin/bash
# ================================================================
#  ALIF24 PLATFORM â€” Penetration Testing & Security Audit Tool
#  Version: 1.0
#  âš ï¸  FAQAT OZ SAYTINGIZDA ISHLATING! BOSHQA SAYTDA BU JINOIY!
#
#  Ishlatish:
#    bash pentest.sh                   â€” To'liq pentest
#    bash pentest.sh headers           â€” HTTP Security Headers audit
#    bash pentest.sh ssl               â€” SSL/TLS zaifliklar
#    bash pentest.sh injection         â€” SQL Injection & XSS test
#    bash pentest.sh cors              â€” CORS misconfiguration
#    bash pentest.sh dirs              â€” Yashirin fayllar / papkalar
#    bash pentest.sh auth              â€” Autentifikatsiya zaifliklar
#    bash pentest.sh ratelimit         â€” Rate Limiting stress test
#    bash pentest.sh stress [N]        â€” DDoS Stress test (N concurrent)
#    bash pentest.sh api               â€” API Fuzzing (notogri malumot)
#    bash pentest.sh recon             â€” Reconnaissance (malumot yig'ish)
#    bash pentest.sh report            â€” Hamma natijani faylga yozish
# ================================================================

VERSION="1.0"

# â”€â”€â”€ Ranglar â”€â”€â”€
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# â”€â”€â”€ Target â”€â”€â”€
TARGET="${PENTEST_TARGET:-https://alif24.uz}"
DOMAIN=$(echo "$TARGET" | sed 's|https\?://||' | sed 's|/.*||')
REPORT_DIR="./pentest_reports"

# â”€â”€â”€ Counters â”€â”€â”€
TOTAL_TESTS=0
PASSED=0
FAILED=0
WARNINGS=0

# â”€â”€â”€ Helpers â”€â”€â”€
header() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${BOLD}$1${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

pass() {
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    PASSED=$((PASSED + 1))
    echo -e "  ${GREEN}âœ… XAVFSIZ:${NC} $1"
}

vuln() {
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    FAILED=$((FAILED + 1))
    echo -e "  ${RED}ðŸš¨ ZAIFLIK:${NC} $1"
}

warning() {
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    WARNINGS=$((WARNINGS + 1))
    echo -e "  ${YELLOW}âš ï¸  OGOHLANTIRISH:${NC} $1"
}

info() {
    echo -e "  ${DIM}â„¹ï¸  $1${NC}"
}

separator() {
    echo -e "  ${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# ================================================================
# 1. RECON â€” Reconnaissance (Malumot Yig'ish)
# ================================================================
cmd_recon() {
    header "RECONNAISSANCE (Malumot Yig'ish) â€” $DOMAIN"
    echo ""

    # Server info
    echo -e "  ${BOLD}1. Server fingerprinting:${NC}"
    local server_header=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null | grep -i "^server:" | head -1)
    if [ -n "$server_header" ]; then
        warning "Server nomi oshkor: $server_header (yashirish kerak!)"
    else
        pass "Server nomi yashirilgan"
    fi

    local powered=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null | grep -i "^x-powered-by:" | head -1)
    if [ -n "$powered" ]; then
        vuln "Texnologiya oshkor: $powered (Haker qaysi tilda yozilganini biladi!)"
    else
        pass "X-Powered-By headeri yashirilgan"
    fi

    # DNS info
    separator
    echo -e "  ${BOLD}2. DNS malumotlari:${NC}"
    local ip=$(dig +short "$DOMAIN" 2>/dev/null | head -1)
    info "IP manzil: ${ip:-nomalum}"

    # Subdomainlar
    separator
    echo -e "  ${BOLD}3. Subdomain / Virtual Hosts:${NC}"
    local subdomains=("harf" "testai" "crm" "games" "olimp" "lessions" "admin" "api" "mail" "ftp" "dev" "staging" "test" "db" "redis" "phpmyadmin" "pgadmin" "grafana" "prometheus")
    for sub in "${subdomains[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "https://${sub}.${DOMAIN}" 2>/dev/null)
        if [ "$code" != "000" ] && [ "$code" != "404" ]; then
            if echo "$sub" | grep -qE "admin|db|redis|phpmyadmin|pgadmin|grafana|prometheus|dev|staging|ftp"; then
                vuln "Xavfli subdomain ochiq: ${sub}.${DOMAIN} - HTTP $code"
            else
                info "${sub}.${DOMAIN} â€” HTTP $code"
            fi
        fi
    done

    # WHOIS
    separator
    echo -e "  ${BOLD}4. Texnologiyalar aniqlovchi:${NC}"
    local resp_headers=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null)
    echo "$resp_headers" | grep -iE "^(content-type|set-cookie|x-|server|via|cf-)" | while read -r line; do
        info "$line"
    done
}

# ================================================================
# 2. HEADERS â€” HTTP Security Headers Audit
# ================================================================
cmd_headers() {
    header "HTTP SECURITY HEADERS AUDIT â€” $TARGET"
    echo ""

    local headers=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null)

    # X-Frame-Options
    echo -e "  ${BOLD}Clickjacking himoyasi:${NC}"
    if echo "$headers" | grep -qi "x-frame-options"; then
        local xfo=$(echo "$headers" | grep -i "x-frame-options" | head -1)
        pass "X-Frame-Options mavjud: $(echo $xfo | xargs)"
    else
        vuln "X-Frame-Options yoq! Sayt Clickjacking hujumiga ochiq."
    fi

    # X-Content-Type-Options
    separator
    echo -e "  ${BOLD}MIME Sniffing himoyasi:${NC}"
    if echo "$headers" | grep -qi "x-content-type-options"; then
        pass "X-Content-Type-Options: nosniff mavjud"
    else
        vuln "X-Content-Type-Options yoq! MIME Sniffing hujumiga ochiq."
    fi

    # X-XSS-Protection
    separator
    echo -e "  ${BOLD}XSS himoyasi:${NC}"
    if echo "$headers" | grep -qi "x-xss-protection"; then
        pass "X-XSS-Protection headeri mavjud"
    else
        warning "X-XSS-Protection headeri yoq (zamonaviy brauzerlar CSP'ga tayanadi)"
    fi

    # Content-Security-Policy
    separator
    echo -e "  ${BOLD}Content Security Policy (CSP):${NC}"
    if echo "$headers" | grep -qi "content-security-policy"; then
        pass "CSP headeri mavjud"
    else
        vuln "Content-Security-Policy yoq! XSS va injection hujumlariga qarshi CSP kerak."
    fi

    # Strict-Transport-Security (HSTS)
    separator
    echo -e "  ${BOLD}HSTS (Strict Transport Security):${NC}"
    if echo "$headers" | grep -qi "strict-transport-security"; then
        pass "HSTS headeri mavjud (HTTPS majburiy)"
    else
        vuln "HSTS headeri yoq! Foydalanuvchi HTTP orqali kirsa malumot ochilib qolishi mumkin."
    fi

    # Referrer-Policy
    separator
    echo -e "  ${BOLD}Referrer-Policy:${NC}"
    if echo "$headers" | grep -qi "referrer-policy"; then
        pass "Referrer-Policy mavjud"
    else
        warning "Referrer-Policy yoq. Malumot boshqa saytlarga sizib ketishi mumkin."
    fi

    # Permissions-Policy
    separator
    echo -e "  ${BOLD}Permissions-Policy:${NC}"
    if echo "$headers" | grep -qi "permissions-policy"; then
        pass "Permissions-Policy mavjud"
    else
        warning "Permissions-Policy yoq (kamera, mikrofon, geolokatsiya nazoratisiz)"
    fi

    # Cookies
    separator
    echo -e "  ${BOLD}Cookie xavfsizligi:${NC}"
    local cookies=$(echo "$headers" | grep -i "set-cookie")
    if [ -n "$cookies" ]; then
        if echo "$cookies" | grep -qi "httponly"; then
            pass "Cookie da HttpOnly flag bor"
        else
            vuln "Cookie da HttpOnly YOQ! JavaScript orqali ogirlash mumkin (XSS bilan)."
        fi
        if echo "$cookies" | grep -qi "secure"; then
            pass "Cookie da Secure flag bor"
        else
            vuln "Cookie da Secure YOQ! HTTP orqali uzatilishi mumkin."
        fi
        if echo "$cookies" | grep -qi "samesite"; then
            pass "Cookie da SameSite flag bor"
        else
            warning "Cookie da SameSite YOQ. CSRF hujumiga ochiq bolishi mumkin."
        fi
    else
        info "Hech qanday Cookie ornatilmagan."
    fi
}

# ================================================================
# 3. SSL â€” SSL/TLS zaifliklar
# ================================================================
cmd_ssl() {
    header "SSL/TLS ZAIFLIK TEKSHIRUVI â€” $DOMAIN"
    echo ""

    # Sertifikat malumotlari
    echo -e "  ${BOLD}1. Sertifikat malumotlari:${NC}"
    local ssl_out=$(echo | timeout 10 openssl s_client -connect "$DOMAIN:443" -servername "$DOMAIN" 2>/dev/null)
    local issuer=$(echo "$ssl_out" | openssl x509 -issuer -noout 2>/dev/null | sed 's/issuer=//')
    local expiry=$(echo "$ssl_out" | openssl x509 -enddate -noout 2>/dev/null | sed 's/notAfter=//')
    info "Issuer: ${issuer:-nomalum}"
    info "Muddat: ${expiry:-nomalum}"

    # TLS versiyalar
    separator
    echo -e "  ${BOLD}2. TLS versiyalar (zaif protokollar):${NC}"
    for ver in tls1 tls1_1; do
        local result=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -"$ver" 2>&1)
        if echo "$result" | grep -q "BEGIN CERTIFICATE"; then
            if [ "$ver" = "tls1" ]; then
                vuln "TLSv1.0 OCHIQ! (Bu eskirgan va zaif protokol)"
            else
                vuln "TLSv1.1 OCHIQ! (Bu eskirgan va zaif protokol)"
            fi
        else
            pass "$ver ochirilgan (togri)"
        fi
    done

    for ver in tls1_2 tls1_3; do
        local result=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -"$ver" 2>&1)
        if echo "$result" | grep -q "BEGIN CERTIFICATE"; then
            pass "$ver qollab-quvvatlanadi"
        else
            warning "$ver qollab-quvvatlanmaydi"
        fi
    done

    # SSLv3 (POODLE)
    separator
    echo -e "  ${BOLD}3. SSLv3 POODLE zaiflik:${NC}"
    local sslv3=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -ssl3 2>&1)
    if echo "$sslv3" | grep -q "BEGIN CERTIFICATE"; then
        vuln "SSLv3 OCHIQ! POODLE hujumiga zaif (CVE-2014-3566)"
    else
        pass "SSLv3 ochirilgan (POODLE dan himoyalangan)"
    fi

    # Heartbleed check (basic)
    separator
    echo -e "  ${BOLD}4. Cipher Strength (zaif shifrlar):${NC}"
    local weak_ciphers=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -cipher "NULL:eNULL:aNULL:DES:RC4:MD5:EXPORT" 2>&1)
    if echo "$weak_ciphers" | grep -q "BEGIN CERTIFICATE"; then
        vuln "ZAIF shifrlar (NULL/DES/RC4/MD5) qollab-quvvatlanadi!"
    else
        pass "Zaif shifrlar ochirilgan"
    fi
}

# ================================================================
# 4. INJECTION â€” SQL Injection & XSS Tekshiruvi
# ================================================================
cmd_injection() {
    header "SQL INJECTION & XSS TEKSHIRUVI â€” $TARGET"
    echo ""

    # SQL Injection payloadlar
    echo -e "  ${BOLD}1. SQL Injection Tekshiruvi:${NC}"
    local sqli_payloads=(
        "' OR '1'='1"
        "1; DROP TABLE users--"
        "' UNION SELECT null,null,null--"
        "1' AND SLEEP(3)--"
        "admin'--"
        "1 OR 1=1"
        "' OR ''='"
    )

    local api_endpoints=(
        "/api/v1/auth/login"
        "/api/v1/users/"
        "/api/v1/search"
        "/api/v1/courses/"
    )

    for endpoint in "${api_endpoints[@]}"; do
        for payload in "${sqli_payloads[@]}"; do
            local start_time=$(date +%s%N)
            local response=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}|%{size_download}|%{time_total}" \
                -X POST "$TARGET$endpoint" \
                -H "Content-Type: application/json" \
                -d "{\"username\":\"$payload\",\"password\":\"$payload\"}" 2>/dev/null)

            local code=$(echo "$response" | cut -d'|' -f1)
            local size=$(echo "$response" | cut -d'|' -f2)
            local time=$(echo "$response" | cut -d'|' -f3)

            # SLEEP injection detection
            if [ "$(echo "$time > 3" | bc 2>/dev/null)" = "1" ]; then
                vuln "TIME-BASED SQL Injection aniqlangan! ${endpoint} - Javob ${time}s kutildi"
            fi

            # Error-based detection
            if [ "$code" = "500" ]; then
                local body=$(curl -sk --max-time 5 "$TARGET$endpoint" \
                    -X POST -H "Content-Type: application/json" \
                    -d "{\"username\":\"$payload\"}" 2>/dev/null)
                if echo "$body" | grep -qiE "sql|syntax|postgresql|column|table|query|select|insert|where"; then
                    vuln "ERROR-BASED SQLi: $endpoint da SQL xato chiqdi"
                fi
            fi
        done
    done
    pass "SQL Injection asosiy tekshiruvlari yakunlandi"

    # XSS
    separator
    echo -e "  ${BOLD}2. XSS (Cross-Site Scripting) Tekshiruvi:${NC}"
    local xss_payloads=(
        "<script>alert(1)</script>"
        "<img src=x onerror=alert(1)>"
        "\"onmouseover=\"alert(1)\""
        "<svg/onload=alert(1)>"
        "javascript:alert(1)"
        "'-alert(1)-'"
    )

    for endpoint in "${api_endpoints[@]}"; do
        for payload in "${xss_payloads[@]}"; do
            local body=$(curl -sk --max-time 5 \
                "$TARGET${endpoint}?q=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$payload'))" 2>/dev/null)" 2>/dev/null)
            if echo "$body" | grep -q "$payload"; then
                vuln "REFLECTED XSS: ${endpoint} da payload aks ettirildi: ${payload:0:30}..."
            fi
        done
    done
    pass "XSS asosiy tekshiruvlari yakunlandi"

    # Command Injection
    separator
    echo -e "  ${BOLD}3. Command Injection Tekshiruvi:${NC}"
    local cmdi_payloads=(
        "; ls -la"
        "| cat /etc/passwd"
        "\$(whoami)"
        "; sleep 5"
    )

    for endpoint in "${api_endpoints[@]}"; do
        for payload in "${cmdi_payloads[@]}"; do
            local body=$(curl -sk --max-time 7 \
                -X POST "$TARGET$endpoint" \
                -H "Content-Type: application/json" \
                -d "{\"query\":\"$payload\"}" 2>/dev/null)

            if echo "$body" | grep -qE "root:|bin/bash|uid="; then
                vuln "COMMAND INJECTION aniqlandi: ${endpoint}"
            fi
        done
    done
    pass "Command Injection tekshiruvlari yakunlandi"
}

# ================================================================
# 5. CORS â€” Cross-Origin Misconfiguration
# ================================================================
cmd_cors() {
    header "CORS MISCONFIGURATION TEKSHIRUVI â€” $TARGET"
    echo ""

    local origins=(
        "https://evil-hacker.com"
        "http://localhost"
        "null"
        "https://${DOMAIN}.evil.com"
        "https://evil.${DOMAIN}"
    )

    echo -e "  ${BOLD}Turli Origin headerlar bilan tekshirish:${NC}"
    for origin in "${origins[@]}"; do
        local resp=$(curl -sk --max-time 5 -H "Origin: $origin" -I "$TARGET/api/v1/health/ping" 2>/dev/null)
        local acao=$(echo "$resp" | grep -i "access-control-allow-origin" | head -1)

        if echo "$acao" | grep -qi "$origin"; then
            vuln "CORS zaiflik: '$origin' qabul qilinadi! Boshqa saytlar API ga sorov yubora oladi"
        elif echo "$acao" | grep -qi "\*"; then
            warning "CORS wildcard (*) ishlatilmoqda. Ehtiyot boling."
        fi
    done
    pass "CORS tekshiruvlari yakunlandi"

    # Credentials with wildcard
    separator
    echo -e "  ${BOLD}Credentials + Wildcard:${NC}"
    local cred_resp=$(curl -sk --max-time 5 -H "Origin: https://evil.com" -I "$TARGET/api/v1/health/ping" 2>/dev/null)
    if echo "$cred_resp" | grep -qi "access-control-allow-credentials: true"; then
        if echo "$cred_resp" | grep -qi "access-control-allow-origin: \*"; then
            vuln "Credentials + Wildcard! Haker foydalanuvchi Cookie sini o'z saytiga yuborishi mumkin!"
        fi
    fi
}

# ================================================================
# 6. DIRS â€” Yashirin Fayllar va Papkalar Qidirish
# ================================================================
cmd_dirs() {
    header "YASHIRIN FAYLLAR VA PAPKALAR â€” $TARGET"
    echo ""

    local sensitive_paths=(
        "/.env"
        "/.git/config"
        "/.git/HEAD"
        "/.gitignore"
        "/wp-admin"
        "/wp-login.php"
        "/phpmyadmin/"
        "/pgadmin/"
        "/admin/"
        "/adminer.php"
        "/.htaccess"
        "/.htpasswd"
        "/server-status"
        "/server-info"
        "/robots.txt"
        "/sitemap.xml"
        "/.well-known/security.txt"
        "/debug"
        "/api/docs"
        "/api/v1/docs"
        "/api/redoc"
        "/swagger.json"
        "/openapi.json"
        "/.DS_Store"
        "/docker-compose.yml"
        "/Dockerfile"
        "/requirements.txt"
        "/package.json"
        "/backup.sql"
        "/dump.sql"
        "/db.sqlite3"
        "/.vscode/"
        "/wp-config.php"
        "/config.php"
        "/info.php"
        "/phpinfo.php"
        "/test.php"
        "/debug.log"
        "/error.log"
        "/access.log"
    )

    echo -e "  ${BOLD}Maxfiy fayllarni izlash (${#sensitive_paths[@]} ta yo'l):${NC}"
    for path in "${sensitive_paths[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "$TARGET$path" 2>/dev/null)
        if [ "$code" = "200" ]; then
            if echo "$path" | grep -qE "\.env|\.git|\.ht|docker-compose|Dockerfile|requirements|dump\.sql|backup|config\.php|phpinfo|debug\.log|db\.sqlite"; then
                vuln "XAVFLI FAYL OCHILIB TURIBDI: ${path} - HTTP 200"
            elif echo "$path" | grep -qE "swagger|openapi|/docs|redoc"; then
                warning "API hujjatlari ochiq: ${path} - HTTP 200"
            else
                info "${path} â€” HTTP $code"
            fi
        elif [ "$code" = "403" ]; then
            pass "${path} â€” bloklangan - HTTP 403"
        fi
    done
}

# ================================================================
# 7. AUTH â€” Autentifikatsiya Zaifliklar
# ================================================================
cmd_auth() {
    header "AUTENTIFIKATSIYA ZAIFLIKLAR â€” $TARGET"
    echo ""

    # Default credentials
    echo -e "  ${BOLD}1. Default / Kuchsiz parollar:${NC}"
    local creds=(
        "admin:admin"
        "admin:password"
        "admin:123456"
        "admin:admin123"
        "root:root"
        "test:test"
        "user:user"
        "admin:alif24"
        "admin@alif24.uz:admin"
        "admin@alif24.uz:123456"
    )

    for cred in "${creds[@]}"; do
        local user=$(echo "$cred" | cut -d: -f1)
        local pass_word=$(echo "$cred" | cut -d: -f2)
        local resp=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" \
            -X POST "$TARGET/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"$user\",\"password\":\"$pass_word\"}" 2>/dev/null)

        if [ "$resp" = "200" ]; then
            vuln "DEFAULT CREDENTIALS ISHLAYDI! $user:$pass_word â€” JIDDIY XAVF!"
        fi
    done
    pass "Default parollar tekshirildi"

    # Brute force protection
    separator
    echo -e "  ${BOLD}2. Brute-Force himoyasi:${NC}"
    local blocked=0
    for i in $(seq 1 15); do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" \
            -X POST "$TARGET/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"brute_test","password":"wrong_pass_'$i'"}' 2>/dev/null)
        if [ "$code" = "429" ] || [ "$code" = "403" ]; then
            blocked=1
            break
        fi
    done
    if [ "$blocked" = "1" ]; then
        pass "Brute-force himoyasi ishlamoqda (Bloklash)"
    else
        vuln "Brute-force himoyasi YOQ! 15 ta notogri parol ketma-ket kiritildi, lekin bloklash bolmadi."
    fi

    # JWT weaknesses
    separator
    echo -e "  ${BOLD}3. JWT Token zaifliklar:${NC}"
    local login_resp=$(curl -sk --max-time 5 \
        -X POST "$TARGET/api/v1/auth/login" \
        -H "Content-Type: application/json" \
        -d '{"username":"test","password":"test"}' 2>/dev/null)

    if echo "$login_resp" | grep -qE "eyJ[A-Za-z0-9_-]+\.eyJ"; then
        local token=$(echo "$login_resp" | grep -oE "eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+" | head -1)
        local header_b64=$(echo "$token" | cut -d. -f1)
        local jwt_header=$(echo "$header_b64" | base64 -d 2>/dev/null)

        if echo "$jwt_header" | grep -qi '"alg":"none"'; then
            vuln "JWT da 'alg: none' bor! Token hech bir imzo tasdiqisiz qabul qilinadi!"
        fi
        if echo "$jwt_header" | grep -qi '"alg":"HS256"'; then
            warning "JWT HS256 ishlatilmoqda. Kuchli secret kalit borligiga ishonch hosil qiling."
        fi
        info "JWT token topildi va tahlil qilindi."
    else
        info "JWT token topilmadi (Yaxshi yoki test uchun login kerak)"
    fi
}

# ================================================================
# 8. RATELIMIT â€” Rate Limiting Stress Test
# ================================================================
cmd_ratelimit() {
    header "RATE LIMITING TEKSHIRUVI â€” $TARGET"
    echo ""

    echo -e "  ${BOLD}1. API Rate Limit (100 ta sorov ketma-ket):${NC}"
    local total=100
    local blocked=0
    local success=0
    local start_time=$(date +%s)

    for i in $(seq 1 $total); do
        local code=$(curl -sk --max-time 2 -o /dev/null -w "%{http_code}" "$TARGET/api/v1/health/ping" 2>/dev/null)
        if [ "$code" = "429" ]; then
            blocked=$((blocked + 1))
        elif [ "$code" = "200" ]; then
            success=$((success + 1))
        fi
    done

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    info "Jami: $total | O'tganlar: $success | Bloklangan: $blocked | Vaqt: ${duration}s"

    if [ "$blocked" -gt 0 ]; then
        pass "Rate limiting ishlamoqda! $blocked ta sorov bloklandi"
    else
        vuln "Rate limiting ISHLAMAYAPTI! $total ta sorovdan biri ham bloklanmadi."
    fi

    # Auth endpoint rate limit
    separator
    echo -e "  ${BOLD}2. Auth endpoint Rate Limit (50 ta login urinishi):${NC}"
    local auth_blocked=0
    for i in $(seq 1 50); do
        local code=$(curl -sk --max-time 2 -o /dev/null -w "%{http_code}" \
            -X POST "$TARGET/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"test","password":"test"}' 2>/dev/null)
        if [ "$code" = "429" ] || [ "$code" = "403" ]; then
            auth_blocked=$((auth_blocked + 1))
        fi
    done

    if [ "$auth_blocked" -gt 0 ]; then
        pass "Auth Rate limiting ishlamoqda! $auth_blocked ta bloklandi"
    else
        vuln "Auth endpoint Rate limiting YOQ! Login sahifaga cheksiz brute-force hujum mumkin."
    fi
}

# ================================================================
# 9. STRESS â€” DDoS Stress Test (Load Testing)
# ================================================================
cmd_stress() {
    local concurrent="${1:-50}"
    local total_requests=500
    header "STRESS TEST (DDoS Simulyatsiya) â€” $TARGET"
    echo ""
    echo -e "  ${YELLOW}âš ï¸  DIQQAT: Bu test serveringizga yuqori yuk beradi!${NC}"
    echo -e "  ${BOLD}Parametrlar: ${concurrent} parallel | ${total_requests} ta sorov${NC}"
    echo ""

    # ab (Apache Bench) mavjudligini tekshirish
    if command -v ab &>/dev/null; then
        echo -e "  ${BOLD}1. Apache Bench bilan stress test:${NC}"
        local ab_result=$(ab -n "$total_requests" -c "$concurrent" -s 10 "${TARGET}/" 2>/dev/null)

        local rps=$(echo "$ab_result" | grep "Requests per second" | awk '{print $4}')
        local time_per=$(echo "$ab_result" | grep "Time per request" | head -1 | awk '{print $4}')
        local failed=$(echo "$ab_result" | grep "Failed requests" | awk '{print $3}')
        local time_taken=$(echo "$ab_result" | grep "Time taken" | awk '{print $4}')

        info "Sorovlar/sek: ${rps:-0}"
        info "O'rt. javob vaqti: ${time_per:-0} ms"
        info "Jami vaqt: ${time_taken:-?} sek"

        if [ -n "$failed" ] && [ "$failed" -gt 0 ]; then
            warning "Stress test davomida $failed ta sorov muvaffaqiyatsiz bo'ldi"
        else
            pass "Barcha sorovlar muvaffaqiyatli qaytdi"
        fi
    else
        echo -e "  ${BOLD}1. curl bilan parallel stress test:${NC}"
        local fail_count=0
        local ok_count=0
        local start_time=$(date +%s)

        for i in $(seq 1 "$total_requests"); do
            curl -sk --max-time 5 -o /dev/null -w "%{http_code}" "$TARGET/" 2>/dev/null &
            if [ $((i % concurrent)) -eq 0 ]; then
                wait
            fi
        done
        wait

        local end_time=$(date +%s)
        local dur=$((end_time - start_time))
        info "${total_requests} ta sorov ${dur} sekundda yakunlandi"
    fi

    # Server response after stress
    separator
    echo -e "  ${BOLD}2. Stress dan keyin server holati:${NC}"
    sleep 2
    local code=$(curl -sk --max-time 10 -o /dev/null -w "%{http_code}" "$TARGET/" 2>/dev/null)
    local time=$(curl -sk --max-time 10 -o /dev/null -w "%{time_total}" "$TARGET/" 2>/dev/null)

    if [ "$code" = "200" ]; then
        pass "Server tirik! HTTP $code, javob vaqti: ${time}s"
    elif [ "$code" = "503" ] || [ "$code" = "502" ]; then
        vuln "Server YIQILDI! HTTP $code â€” DDoS hujumiga chidami YOQ!"
    else
        warning "Server javob berdi: HTTP $code - ${time}s"
    fi
}

# ================================================================
# 10. API â€” API Fuzzing (Notogri Malumotlar)
# ================================================================
cmd_api() {
    header "API FUZZING TEKSHIRUVI â€” $TARGET"
    echo ""

    # Notogri metodlar
    echo -e "  ${BOLD}1. HTTP Method Tampering:${NC}"
    local methods=("DELETE" "PUT" "PATCH" "OPTIONS" "TRACE" "CONNECT")
    for method in "${methods[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" -X "$method" "${TARGET}/" 2>/dev/null)
        if [ "$code" = "200" ]; then
            if [ "$method" = "TRACE" ] || [ "$method" = "CONNECT" ]; then
                vuln "Xavfli method ochiq: $method - HTTP $code"
            else
                warning "$method method yoqilgan: HTTP $code"
            fi
        fi
    done

    # Katta payload
    separator
    echo -e "  ${BOLD}2. Oversized Payload - Body hajmi bomba:${NC}"
    local big_payload=$(python3 -c "print('A'*10000)" 2>/dev/null || echo "AAAAAAAAAA")
    local code=$(curl -sk --max-time 10 -o /dev/null -w "%{http_code}" \
        -X POST "$TARGET/api/v1/auth/login" \
        -H "Content-Type: application/json" \
        -d "{\"data\":\"$big_payload\"}" 2>/dev/null)

    if [ "$code" = "413" ] || [ "$code" = "400" ]; then
        pass "Katta payload bloklandi - HTTP $code"
    elif [ "$code" = "200" ]; then
        vuln "Katta payload QABUL QILINDI! Memory exhaustion hujumiga ochiq."
    else
        info "Server javob: HTTP $code"
    fi

    # Path traversal
    separator
    echo -e "  ${BOLD}3. Path Traversal (Fayl o'qish hujumi):${NC}"
    local traversals=(
        "/../../../etc/passwd"
        "/..%2f..%2f..%2fetc/passwd"
        "/api/v1/../../etc/passwd"
        "/static/../../../etc/shadow"
    )
    for path in "${traversals[@]}"; do
        local body=$(curl -sk --max-time 5 "$TARGET$path" 2>/dev/null)
        if echo "$body" | grep -qE "root:|/bin/bash|nobody"; then
            vuln "PATH TRAVERSAL ZAIFLIK: $path da server fayllari oqiladi!"
        fi
    done
    pass "Path Traversal tekshiruvlari yakunlandi"

    # SSRF
    separator
    echo -e "  ${BOLD}4. SSRF (Server-Side Request Forgery):${NC}"
    local ssrf_targets=(
        "http://127.0.0.1:5432"
        "http://localhost:6379"
        "http://169.254.169.254/latest/meta-data/"
    )
    for ssrf_url in "${ssrf_targets[@]}"; do
        local body=$(curl -sk --max-time 5 \
            -X POST "$TARGET/api/v1/health/ping" \
            -H "Content-Type: application/json" \
            -d "{\"url\":\"$ssrf_url\"}" 2>/dev/null)
        if echo "$body" | grep -qE "ami-|instance-id|PostgreSQL|PONG|Redis"; then
            vuln "SSRF Zaiflik! Server ichki xizmatga sorov yubordi: $ssrf_url"
        fi
    done
    pass "SSRF tekshiruvlari yakunlandi"

    # Open Redirect
    separator
    echo -e "  ${BOLD}5. Open Redirect:${NC}"
    local redirect_resp=$(curl -sk --max-time 5 -o /dev/null -w "%{redirect_url}" "$TARGET/api/v1/auth/login?next=https://evil.com" 2>/dev/null)
    if echo "$redirect_resp" | grep -q "evil.com"; then
        vuln "OPEN REDIRECT zaiflik: Foydalanuvchi evil.com ga yo'naltirilishi mumkin!"
    else
        pass "Open Redirect zaiflik topilmadi"
    fi
}

# ================================================================
# FULL PENTEST â€” Hammasi birga  
# ================================================================
cmd_full() {
    echo ""
    echo -e "${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}${BOLD}â•‘  ALIF24 PENETRATION TEST v${VERSION}                         â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘  Target: $TARGET                            â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘  Sana: $(date '+%Y-%m-%d %H:%M:%S')                          â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘  âš ï¸  FAQAT OZ LOYIHANGIZDA ISHLATING!                   â•‘${NC}"
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    cmd_recon
    cmd_headers
    cmd_ssl
    cmd_injection
    cmd_cors
    cmd_dirs
    cmd_auth
    cmd_ratelimit
    cmd_api

    # Final Report
    echo ""
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${BOLD}YAKUNIY NATIJA:${NC}"
    echo ""
    echo -e "  Jami testlar:      ${BOLD}$TOTAL_TESTS${NC}"
    echo -e "  ${GREEN}Xavfsiz (pass):${NC}    ${GREEN}$PASSED${NC}"
    echo -e "  ${YELLOW}Ogohlantirishlar:${NC}  ${YELLOW}$WARNINGS${NC}"
    echo -e "  ${RED}ZAIFLIKLAR:${NC}        ${RED}$FAILED${NC}"
    echo ""

    if [ "$FAILED" -eq 0 ]; then
        echo -e "  ${GREEN}${BOLD}ðŸ›¡ï¸  MUKAMMAL! Hech qanday jiddiy zaiflik topilmadi!${NC}"
    elif [ "$FAILED" -le 3 ]; then
        echo -e "  ${YELLOW}${BOLD}âš ï¸  BA'ZI ZAIFLIKLAR bor. Yuqoridagi QIZILlarni tuzating.${NC}"
    else
        echo -e "  ${RED}${BOLD}ðŸš¨ JIDDIY XAVF! $FAILED ta zaiflik topildi. TEZDA TUZATING!${NC}"
    fi
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# ================================================================
# REPORT â€” Natijalarni faylga saqlash
# ================================================================
cmd_report() {
    mkdir -p "$REPORT_DIR"
    local file="$REPORT_DIR/pentest_$(date +%Y%m%d_%H%M%S).txt"
    header "PENTEST HISOBOT"
    echo -e "  ${YELLOW}Hisobot yozilmoqda: $file${NC}"
    cmd_full 2>&1 | sed 's/\x1b\[[0-9;]*m//g' > "$file"
    local size=$(du -sh "$file" | awk '{print $1}')
    echo -e "  ${GREEN}Hisobot saqlandi: $file -- $size${NC}"
}

# ================================================================
# MAIN â€” Command Router
# ================================================================
case "${1:-full}" in
    recon)     cmd_recon ;;
    headers)   cmd_headers ;;
    ssl)       cmd_ssl ;;
    injection) cmd_injection ;;
    cors)      cmd_cors ;;
    dirs)      cmd_dirs ;;
    auth)      cmd_auth ;;
    ratelimit) cmd_ratelimit ;;
    stress)    cmd_stress "$2" ;;
    api)       cmd_api ;;
    full)      cmd_full ;;
    report)    cmd_report ;;
    help|--help|-h)
        echo ""
        echo -e "${RED}${BOLD}  ALIF24 Pentest Tool v${VERSION}${NC}"
        echo ""
        echo -e "  ${BOLD}Ishlatish:${NC} bash pentest.sh [command] [args]"
        echo ""
        echo -e "  ${BOLD}Buyruqlar:${NC}"
        echo "    bosh           To'liq pentest hammasi"
        echo "    recon         Reconnaissance - malumot yig'ish"
        echo "    headers       HTTP Security Headers audit"
        echo "    ssl           SSL/TLS zaifliklar"
        echo "    injection     SQL Injection va XSS tekshiruvi"
        echo "    cors          CORS misconfiguration"
        echo "    dirs          Yashirin fayllar / papkalar qidirish"
        echo "    auth          Autentifikatsiya zaifliklar"
        echo "    ratelimit     Rate Limiting tekshiruvi"
        echo "    stress [N]    DDoS Stress test - N concurrent, default: 50"
        echo "    api           API Fuzzing - notogri malumot"
        echo "    report        Hamma natijani faylga saqlash"
        echo ""
        echo -e "  ${BOLD}Target ozgartirish:${NC}"
        echo "    PENTEST_TARGET=https://harf.alif24.uz bash pentest.sh"
        echo ""
        echo -e "  ${RED}FAQAT OZ SAYTINGIZDA ISHLATING!${NC}"
        echo ""
        ;;
    *)
        echo -e "${RED}Nomalum buyruq: $1${NC}"
        echo "bash pentest.sh help"
        ;;
esac
